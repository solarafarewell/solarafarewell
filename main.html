<!doctype html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solara Farewell - Memorial Services</title>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&amp;family=Playfair+Display:wght@400;600;700&amp;family=Merriweather:wght@300;400;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>

  <style>
    /* 
       IMAGE SLOTS - edit here only
       
       These variables default to the same filenames you were using.
       To change an image later, update the URL inside the variable.
       Example: --service-banner-img: url("my-new-services-bg.jpg");
    */
    :root{
      /* Service banner background (default: services-bg.jpg) */
      --service-banner-img: url("gsbg.jpg");

      /* Hero fallback for video (if you want to use an image fallback later) */
      --hero-fallback-img: url("herobg1.jpg"); /* optional - not used unless you change hero CSS */

      /* Section backgrounds (if you want to add later) - currently unused, but ready */
      --about-bg: url("bg-about.jpg");
      --services-bg: url("bg-services.jpg");
      --themes-bg: url("bg-themes.jpg");
      --obituaries-bg: url("bg-obituaries.jpg");
      --support-bg: url("bg-support.jpg");
      --faq-bg: url("bg-faq.jpg");
      --flowers-bg: url("bg-flowers.jpg");
      --contact-bg: url("bg-contact.jpg");
      --order-bg: url("bg-order.jpg");

      /* Design gallery placeholders (casket/urn images) - defaults kept the same */
      --casket1: url("casket1.jpg");
      --casket2: url("casket2.jpg");
      --casket3: url("casket3.jpg");
      --casket4: url("casket4.jpg");
      --urn1: url("urn1.jpg");
      --urn2: url("urn2.jpg");
      --urn3: url("urn3.jpg");
      --urn4: url("urn4.jpg");
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Merriweather', serif;
      color: #2f4963;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    .app-wrapper {
      width: 100%;
      min-height: 100%;
    }

    /* Navigation */
    .nav-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #2f4963;
    }

    .main-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem 2rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .main-nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      transition: color 0.3s;
      white-space: nowrap;
    }

    /* Mobile hamburger button (hidden on desktop) */
    .nav-toggle {
      display: none;
      background: transparent;
      border: none;
      color: white;
      padding: 0.5rem;
      cursor: pointer;
    }

    .nav-toggle:focus {
      outline: 2px dashed rgba(215,154,41,0.6);
      outline-offset: 3px;
    }

    .hamburger {
      display: block;
      width: 24px;
      height: 2px;
      background: white;
      position: relative;
      transition: transform 0.25s ease-in-out;
    }

    .hamburger::before,
    .hamburger::after {
      content: "";
      position: absolute;
      left: 0;
      width: 24px;
      height: 2px;
      background: white;
      transition: transform 0.25s ease-in-out, top 0.2s ease-in-out;
    }

    .hamburger::before { top: -7px; }
    .hamburger::after { top: 7px; }

    .nav-container.nav-open .hamburger {
      background: transparent;
    }

    .nav-container.nav-open .hamburger::before {
      transform: rotate(45deg) translate(4px, 4px);
      top: 0;
    }

    .nav-container.nav-open .hamburger::after {
      transform: rotate(-45deg) translate(4px, -4px);
      top: 0;
    }

    .main-nav a:hover {
      color: #d79a29;
    }

    .info-bar {
      background: #3a6082;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 2rem;
      color: white;
      font-size: 0.85rem;
      flex-wrap: wrap;
      gap: 1rem;
      position: relative;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* center the phone visually on the same line */
    .info-phone {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      pointer-events: none;
    }
    .info-phone span { pointer-events: auto; }

    /* fallback on small screens: stacked centered */
    @media (max-width: 600px) {
      .info-phone { position: static; transform: none; width: 100%; justify-content: center; order: 2; margin-top: 0.25rem; pointer-events: auto; }
    }

    .info-item span:first-child {
      color: #d79a29;
    }

    /* Hero Section */
    .hero-section {
      height: 100vh;
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-top: 0;
      background: #000; /* fallback if video doesn't load - kept original */
      overflow: hidden;
    }

    /* HERO BACKGROUND VIDEO (unchanged) */
    .hero-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.35);
      z-index: 0;
    }

    .hero-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(47, 73, 99, 0.5);
      z-index: 1;
    }

    .hero-content {
      position: relative;
      z-index: 2;
      padding: 2rem;
      animation: fadeInUp 1.5s ease-out;
    }

    .hero-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 2rem;
      border: 4px solid #d79a29;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(215, 154, 41, 0.1);
      overflow: hidden;
    }

    /* LOGO IMAGE */
    .hero-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-logo-text {
      font-family: 'Great Vibes', cursive;
      font-size: 2.5rem;
      color: #d79a29;
    }

    .hero-title {
      font-family: 'Great Vibes', cursive;
      font-size: 4rem;
      color: #d79a29;
      margin-bottom: 1rem;
    }

    .hero-subtitle {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: white;
      font-weight: 300;
    }

    /* Gold Divider */
    .gold-divider {
      height: 2px;
      background: #d79a29;
      width: 100%;
      margin: 3rem 0;
    }

    /* Section Styles */
    .section {
      padding: 3rem 2rem;
      width: 100%;
    }

    .section-dark {
      background: #2f4963;
      color: white;
    }

    .section-title {
      font-family: 'Great Vibes', cursive;
      font-size: 3rem;
      color: #d79a29;
      text-align: center;
      margin-bottom: 2rem;
    }

    .section-heading {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: #d79a29;
      margin-bottom: 1rem;
       text-align: center;
    }

    .section-text {
      font-size: 1rem;
      line-height: 1.8;
      margin-bottom: 1.5rem;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* About Section */
    .about-content {
      max-width: 1000px;
      margin: 0 auto;
      animation: fadeInUp 1s ease-out;
    }

    /* Services Section */
    .service-banner {
      width: 100%;
      height: 200px;
      /* kept original services background; now uses a variable slot so nothing changes visually */
      background: var(--service-banner-img) center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 3rem;
    }

    .service-banner h2 {
      font-family: 'Great Vibes', cursive;
      font-size: 4rem;
      color: #d79a29;
      letter-spacing: 4px;
    }

    .service-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 3rem auto;
    }

    .service-card {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      animation: floatGentle 3s ease-in-out infinite;
      display: flex;
      flex-direction: column;
    }

    .service-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .service-card h3 {
      font-family: 'Playfair Display', serif;
      color: #2f4963;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }

    .service-card p {
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    /* SERVICE IMAGES - RETURNED TO ORIGINAL FILES, but now use variables so you can change later */
    .room-includes { margin:4px 0 10px 0; padding-left:18px; color:#2f4963; }
    .room-includes li { margin:4px 0; font-size:0.9rem; }
    .service-image {
      width: 100%;
      height: 200px;
      border-radius: 15px;
      margin-bottom: 1.5rem;
      display: block;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Design modal editable item styles */
    .design-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr)); gap:12px; }
    /* Default design item (keeps previous compact square look) */
    .design-item { height:120px; border-radius:8px; background-size:cover; background-position:center; position:relative; cursor:pointer; }

    /* Room showcase uses the same service-card styles (reused) */
    /* removed per-card mini-calendars â€” bookings open via the Book button */

    /* Booking modal */
    .booking-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:11000; justify-content:center; align-items:center; padding:1rem; }
    .booking-box { background:#fff; width:100%; max-width:560px; max-height:100vh; border-radius:12px; padding:1rem; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:0.75rem; }
    .booking-header { display:flex; justify-content:space-between; align-items:center; }
    .booking-calendar { display:grid; grid-template-columns: repeat(7,1fr); gap:6px; }
    .cal-day { position:relative; }
    .book-controls { position:absolute; top:4px; right:4px; display:none; gap:6px; }
    .cal-day.booked:hover .book-controls { display:flex; }
    .meatball-btn { background:transparent; border:none; color:inherit; cursor:pointer; padding:2px 4px; }
    .cell-menu { display:flex; flex-direction:column; color: #2f4963; }
    .cell-menu button { background:transparent; border:none; padding:8px 10px; text-align:left; width:100%; color: #2f4963; }
    .cell-menu button:hover { background:#f3f5f6; }
    /* popup shown after user submits the external form */
    .form-submit-popup {
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background: #ffffff;
      border-radius:14px;
      box-shadow: 0 20px 60px rgba(18,36,46,0.12);
      z-index:12000;
      padding:28px 30px;
      width:60%;
      height:50vh;
      max-width:1100px;
      min-width:360px;
      color:#2f4963; /* site blue */
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:center;
      overflow:hidden;
      animation: popupIn 420ms cubic-bezier(.2,.9,.2,1);
      border-top: 4px solid #d79a29; /* gold accent */
    }
    .form-submit-popup::before{
      content:'';
      position:absolute;
      right:18px;
      top:18px;
      width:72px;
      height:72px;
      border-radius:20px;
      background: radial-gradient(circle at 30% 30%, rgba(215,154,41,0.98), rgba(215,154,41,0.85));
      box-shadow: 0 8px 28px rgba(215,154,41,0.12);
      transform: rotate(-8deg);
      animation: floatDec 4s ease-in-out infinite;
    }
    .form-submit-popup p { margin:0; font-weight:700; font-size:1.25rem; letter-spacing:0.2px; color: #2f4963; }
    .form-submit-popup .info { font-size:1rem; color:#3a6082; }
    .form-submit-actions { display:flex; gap:14px; width:100%; }
    .form-submit-actions button { flex:1; padding:12px 16px; font-size:1rem; border-radius:10px; }
    .form-submit-actions .primary { background: linear-gradient(90deg,#2f4963,#174a45); color:#fff; border:none; box-shadow:0 8px 24px rgba(47,73,99,0.12); }
    .form-submit-actions .secondary { background:transparent; color:#d79a29; border:1px solid rgba(215,154,41,0.25); }

    @keyframes popupIn {
      from { opacity:0; transform: translateX(-50%) translateY(-8px) scale(0.98); }
      to { opacity:1; transform: translateX(-50%) translateY(0) scale(1); }
    }
    @keyframes floatDec {
      0% { transform: translateY(0) rotate(-8deg); }
      50% { transform: translateY(-6px) rotate(-6deg); }
      100% { transform: translateY(0) rotate(-8deg); }
    }

    @media (max-width:800px){
      .form-submit-popup{ width:92%; left:50%; top:50%; transform:translate(-50%,-50%); height:60vh; padding:18px; }
      .form-submit-popup::before{ display:none; }
    }
    /* Pending booking banner */
    .pending-banner { position:fixed; right:18px; bottom:18px; background:#ffffff; border-radius:12px; padding:12px 14px; box-shadow:0 10px 30px rgba(18,36,46,0.06); z-index:13000; min-width:260px; max-width:360px; color:#123b36; display:flex; gap:10px; align-items:center; border-left:4px solid #d79a29; }
    .pending-banner .pb-info { flex:1; font-size:0.95rem; color:#2f4963; }
    .pending-banner .pb-actions { display:flex; gap:8px; }
    .pending-banner .pb-actions button { padding:8px 10px; border-radius:8px; font-size:0.95rem; }
    .pending-banner .primary { background: linear-gradient(90deg,#2f4963,#174a45); color:#fff; border:none; box-shadow:0 8px 18px rgba(47,73,99,0.08); }
    .pending-banner .cancel { background:transparent; border:1px solid rgba(215,154,41,0.18); color:#d79a29; }
    /* Inbox panel styles. The floating Pending button was removed per user preference. */
    .inbox-panel { position:fixed; right:0; top:8vh; height:84vh; width:360px; max-width:92vw; background:#ffffff; box-shadow: -10px 20px 60px rgba(18,36,46,0.06); z-index:13510; border-left:1px solid rgba(47,73,99,0.04); padding:12px; display:flex; flex-direction:column; gap:8px; }
    .inbox-panel h3 { margin:0; font-size:1.05rem; color:#d79a29; background:#2f4963; padding:8px 10px; border-radius:8px; }
    .inbox-list { overflow:auto; padding:6px; display:flex; flex-direction:column; gap:8px; }
    .inbox-item { border-radius:8px; padding:8px; background:#ffffff; box-shadow:0 6px 18px rgba(47,73,99,0.04); display:flex; flex-direction:column; gap:6px; border:1px solid rgba(47,73,99,0.03); }
    .inbox-item .meta { font-size:0.9rem; color:#2f4963; }
    .inbox-item .dates { font-size:0.92rem; color:#123b36; font-weight:600; }
    .inbox-item .inbox-actions { display:flex; gap:8px; justify-content:flex-end; }
    .inbox-item .inbox-actions button { padding:6px 8px; border-radius:8px; }
    .cal-day { padding:8px 6px; text-align:center; border-radius:6px; background:#f7f7f7; cursor:pointer; }
    .cal-day.selected-range { background: rgba(47,73,99,0.08); }
    .cal-day.booked { background:#e76f51; color:#fff; cursor:not-allowed; }
    .cal-day.today { box-shadow: inset 0 0 0 2px rgba(215,154,41,0.15); }
    .booking-actions { display:flex; gap:0.5rem; justify-content:space-between; margin-top:0.5rem; align-items:center; }
    .booking-actions button { flex:1; min-width:0; padding:0.65rem 0.9rem; margin:0; }
    .booking-actions .show-more-btn { margin-top:0; margin-bottom:0; }
    .booking-actions button + button { margin-left:0.5rem; }

    @media (max-width:600px) {
      .booking-box { max-width: 92%; }
      .design-grid { grid-template-columns: 1fr; }
    }
    /* Make cremation gallery items portrait (3:4) when opened */
    .design-item[data-type^="crem"] {
      aspect-ratio: 3 / 4;
      height: auto; /* allow aspect-ratio to control size */
      min-height: 180px;
      border-radius: 8px;
    }
    .design-item .edit-btn { position:absolute; right:6px; top:6px; background:rgba(0,0,0,0.55); color:#fff; border:none; padding:4px 6px; border-radius:4px; font-size:0.8rem; display:none !important; }
    /* Edit buttons intentionally hidden in the live site */
    .design-item:hover .edit-btn { display:none !important; }
    .design-editor { position:absolute; inset:0; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; gap:6px; padding:8px; align-items:center; justify-content:center; }
    .design-editor input[type="text"] { width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; }
    .design-editor input[type="file"] { width:100%; }
    .design-editor .editor-actions { display:flex; gap:6px; }

    /* Burial */
    .service-image.burial-basic {
      background-image: var(--burial-basic, url("premb.jpg"));
    }
    .service-image.burial-premium {
      background-image: var(--burial-premium, url("basicb.jpg"));
    }
    .service-image.burial-deluxe {
      background-image: var(--burial-deluxe, url("deluxeb.jpg"));
    }

    /* Cremation */
    .service-image.crem-basic {
      background-image: var(--crem-basic, url("basicp.jpg"));
    }
    .service-image.crem-memorial {
      background-image: var(--crem-memorial, url("premp.jpg"));
    }
    .service-image.crem-premium {
      background-image: var(--crem-premium, url("delc.jpg"));
    }

    /* Online memorial */
    .service-image.online-eburo {
      background-image: var(--online-eburo, url("olb.jpg"));
    }

    /* Room images for Room Options */
    .service-image.room-basic {
      background-image: var(--room-basic, url("room-basic-1.jpg"));
    }
    .service-image.room-premium {
      background-image: var(--room-premium, url("room-premium-1.jpg"));
    }
    .service-image.room-deluxe {
      background-image: var(--room-deluxe, url("room-deluxe-1.jpg"));
    }

    /* Show More button in cards */
    .show-more-btn {
      margin-top: auto;
      margin-bottom: 1.5rem;
      padding: 0.6rem 1.3rem;
      background: #2f4963;
      color: white;
      border: none;
      border-radius: 20px;
      font-family: 'Playfair Display', serif;
      cursor: pointer;
      transition: transform 0.3s, background 0.3s;
      display: inline-block;
      text-decoration: none;
    }

    .show-more-btn:hover {
      transform: scale(1.05);
      background: #3a6082;
    }

    /* Theme & Casket Cards */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 2rem auto;
    }

    .theme-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .theme-card:hover {
      transform: translateY(-8px);
    }

    .theme-image {
      width: 100%;
      height: 250px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* CREMATION THEME IMAGES - same filenames as before (no visible change) */
    .theme-image.theme-halo {
      background-image: var(--theme-halo, url("theme-halo.jpg"));
    }
    .theme-image.theme-imperial {
      background-image: var(--theme-imperial, url("theme-imperial.jpg"));
    }
    .theme-image.theme-luxe {
      background-image: var(--theme-luxe, url("theme-luxe.jpg"));
    }

    .theme-content {
      padding: 1.5rem;
    }

    /* Casket Images */
    .casket-image {
      width: 100%;
      height: 200px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .casket-image.casket-basic { background-image: url("casket-premium.jpg"); }
    .casket-image.casket-premium { background-image: url("casket-basic.jpg"); }
    .casket-image.casket-deluxe { background-image: url("casket-deluxe.jpg"); }

    .theme-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      color: #2f4963;
      margin-bottom: 0.5rem;
    }

    .theme-price {
      font-size: 1.2rem;
      color: #d79a29;
      font-weight: bold;
    }

    .casket-card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .casket-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      color: #2f4963;
      margin-bottom: 1rem;
    }

    .casket-price {
      font-size: 1.3rem;
      color: #d79a29;
      font-weight: bold;
    }

    /* Obituaries */
    .obituary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 320px));
      gap: 2rem;
      max-width: 1200px;
      margin: 2rem auto;
      justify-content: center;
    }

    /* Pagination for Obituaries */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .pagination button {
      background: white;
      color: #2f4963;
      border: 1px solid rgba(47,73,99,0.12);
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Playfair Display', serif;
    }

    .pagination button.active {
      background: #d79a29;
      color: white;
      border-color: #d79a29;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .obituary-card {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
      cursor: pointer;
    }

    .obituary-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .obituary-photo {
      width: 100%;
      height: 280px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* preserved original obit images */
    .obituary-photo.obit-asis {
      background-image: var(--obit-asis, url("obit-asis.jpg"));
    }
    .obituary-photo.obit-baltazar {
      background-image: var(--obit-baltazar, url("obit-baltazar.jpg"));
    }
    .obituary-photo.obit-alicarte {
      background-image: var(--obit-alicarte, url("obit-alicarte.jpg"));
    }
    .obituary-photo.obit-cruz {
      background-image: var(--obit-cruz, url("obit-cruz.jpg"));
    }

    .obituary-info {
      padding: 1.5rem;
      text-align: center;
    }

    .obituary-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: #2f4963;
      margin-bottom: 0.5rem;
    }

    .obituary-dates {
      color: #3a6082;
      font-size: 0.95rem;
    }

    .obituary-search-container {
      max-width: 500px;
      margin: 0 auto 2rem;
      padding: 0 1rem;
    }

    .obituary-search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #d79a29;
      border-radius: 8px;
      font-family: 'Merriweather', serif;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .obituary-search-input:focus {
      outline: none;
      border-color: #2f4963;
      box-shadow: 0 0 0 3px rgba(47, 73, 99, 0.1);
    }

    .obituary-card.hidden {
      display: none;
    }

    /* FAQ */
    .faq-section {
      max-width: 1000px;
      margin: 0 auto;
    }

    .faq-category {
      margin-bottom: 3rem;
    }

    .faq-category-title {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: #2f4963;
      margin-bottom: 1.5rem;
    }

    .faq-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .faq-chip {
      background: white;
      border: 2px solid #d79a29;
      color: #2f4963;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-size: 0.95rem;
      transition: transform 0.3s, background 0.3s;
      cursor: pointer;
    }

    .faq-chip:hover {
      transform: translateY(-5px);
      background: #d79a29;
      color: white;
    }

    .faq-item {
      display: inline-block;
      max-width: 100%;
    }

    .faq-answer {
      display: none;
      margin-top: 0.5rem;
      background: #ffffff;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      border: 1px solid rgba(215, 154, 41, 0.3);
      font-size: 0.9rem;
      line-height: 1.6;
      color: #2f4963;
    }

    /* Flowers Section */
    .flower-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 2rem auto;
    }

    .flower-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .flower-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: #2f4963;
      margin-bottom: 0.5rem;
    }

    .flower-price {
      font-size: 1.2rem;
      color: #d79a29;
      font-weight: bold;
    }

    .flower-image {
      width: 100%;
      height: 200px;
      border-radius: 12px;
      margin-bottom: 1rem;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .flower-image.flowers-serene {
      background-image: var(--flowers-serene, url("serene-flowers.jpg"));
    }
    .flower-image.flowers-golden {
      background-image: var(--flowers-golden, url("flowers-golden.jpg"));
    }
    .flower-image.flowers-radiance {
      background-image: var(--flowers-radiance, url("flowers-radiance.jpg"));
    }
    .flower-image.flowers-eternal {
      background-image: var(--flowers-eternal, url("flowers-eternal.jpg"));
    }
    .flower-image.flowers-remember {
      background-image: var(--flowers-remember, url("flowers-remember.jpg"));
    }

    /* Support Buttons */
    .support-buttons {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .support-btn {
      background: #d79a29;
      color: white;
      padding: 1rem 2rem;
      border-radius: 30px;
      text-decoration: none;
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      transition: transform 0.3s, background 0.3s;
      display: inline-block;
    }

    .support-btn:hover {
      transform: scale(1.05);
      background: #c28920;
    }

    /* Contact Section */
    .contact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 3rem;
      max-width: 1200px;
      margin: 2rem auto;
    }

    .contact-form {
      background: #fffaed;
      padding: 2rem;
      border-radius: 15px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-family: 'Playfair Display', serif;
      color: #2f4963;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #d79a29;
      border-radius: 8px;
      font-family: 'Merriweather', serif;
      font-size: 0.95rem;
      background: white;
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }

    .submit-btn {
      background: #2f4963;
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
      width: 100%;
    }

    .submit-btn:hover {
      background: #3a6082;
    }

    .privacy-note {
      font-size: 0.8rem;
      color: #666;
      margin-top: 1rem;
    }

    .contact-info {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .contact-detail {
      margin-bottom: 1.5rem;
    }

    .contact-detail-label {
      font-family: 'Playfair Display', serif;
      color: #d79a29;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .social-links {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .social-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #f5f5f5;
      transition: all 0.3s ease;
      text-decoration: none;
      border: 2px solid transparent;
    }

    .social-link:hover {
      background: #d79a29;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(215, 154, 41, 0.3);
    }

    .social-link:hover svg {
      fill: white;
    }

    .social-link svg {
      transition: fill 0.3s ease;
    }

    .map-placeholder {
      width: 100%;
      height: 300px;
      background: url("map.jpg") center/cover no-repeat;
      border-radius: 15px;
      margin-top: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgb(0, 0, 0);
      font-size: 1.2rem;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.3s ease;
    }

    .map-placeholder:hover {
      transform: scale(1.02);
    }

    /* Order Section */
    .order-section {
      background: #2f4963;
      color: white;
      padding: 4rem 2rem;
      text-align: center;
    }

    .order-title {
      font-family: 'Great Vibes', cursive;
      font-size: 3.5rem;
      color: #d79a29;
      margin-bottom: 1rem;
      border-bottom: 4px solid #000;
      display: inline-block;
      padding-bottom: 0.5rem;
    }

    .order-btn {
      display: inline-block;
      background: #d79a29;
      color: white;
      padding: 1rem 2rem;
      border-radius: 30px;
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      text-decoration: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .order-btn:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    /* Design Gallery Modal */
    .design-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .design-box {
      background: white;
      max-width: 800px;
      width: 90%;
      padding: 1.5rem;
      border-radius: 20px;
      animation: fadeInUp 0.5s ease-out;
      text-align: center;
    }

    /* Certificates modal full-screen override */
    #certificatesModal .design-box {
      width: 96%;
      height: 94vh;
      max-width: none;
      padding: 1rem;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .close-btn {
      float: right;
      font-size: 1.2rem;
      cursor: pointer;
      color: #2f4963;
    }

    .design-grid {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .design-item {
      height: 150px;
      border-radius: 12px;
      background-size: cover;
      background-position: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    /* Mobile tweaks for design gallery: larger items and constrained modal height */
    @media (max-width: 600px) {
      .design-modal { align-items: flex-start; padding-top: 6vh; }
      .design-box {
        width: 92%;
        max-width: 520px;
        padding: 1rem;
        border-radius: 14px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .design-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
        overflow-y: auto;
        padding-right: 6px;
      }
      .design-item {
        height: auto;
        min-height: 220px;
        border-radius: 12px;
      }
      /* Ensure cremation items stay portrait and larger */
      .design-item[data-type^="crem"] {
        aspect-ratio: 3 / 4;
        min-height: 260px;
      }
      .close-btn { font-size: 1.4rem; }
    }

    /* Certificates thumbnails */
    #certificatesGrid { overflow:auto; padding:8px; display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
    #certificatesGrid img { width:100%; height:220px; object-fit:contain; border-radius:8px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.12); cursor:zoom-in; }
    #certificatesGrid .cert-placeholder { display:flex; align-items:center; justify-content:center; padding:1rem; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08); color:#2f4963; }

    /* Lightbox for enlarged certificate */
    .img-lightbox {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.9);
      z-index:10000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .img-lightbox img { max-width:100%; max-height:100%; object-fit:contain; border-radius:6px; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
    .img-lightbox .lb-close { position:absolute; right:18px; top:18px; background:rgba(255,255,255,0.9); border-radius:6px; padding:6px 10px; cursor:pointer; color:#2f4963; font-weight:700; }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes floatGentle {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-container {
        position: relative;
      }

      /* Make the hamburger toggle a small circular button in the upper-right on mobile */
      .nav-toggle {
        display: flex;
        position: fixed;
        right: 1rem;
        top: 1rem;
        left: auto;
        height: 56px;
        width: 56px;
        margin: 0;
        padding: 0;
        border-radius: 999px;
        background: #d79a29;
        border: none;
        box-shadow: 0 6px 18px rgba(0,0,0,0.22);
        z-index: 10070;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      /* larger touch target and white hamburger lines on mobile */
      .nav-toggle .hamburger {
        width: 28px;
        height: 3px;
        background: white;
        border-radius: 2px;
      }

      .nav-toggle .hamburger::before,
      .nav-toggle .hamburger::after {
        width: 28px;
        height: 3px;
        background: white;
        border-radius: 2px;
      }

      .main-nav {
        display: none;
        flex-direction: column;
        gap: 0;
        padding: 0.75rem 1rem;
        background: #2f4963;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        top: auto;
        width: 100%;
        height: 0;
        max-height: 80vh;
        z-index: 1050;
        box-shadow: 0 -6px 24px rgba(0,0,0,0.18);
        border-top-left-radius: 14px;
        border-top-right-radius: 14px;
        overflow: hidden;
        transform: translateY(100%);
        transition: transform 0.35s ease, height 0.35s ease;
      }

      .main-nav a {
        padding: 0.9rem 1rem;
        font-size: 0.95rem;
        white-space: nowrap;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        display: block;
      }

      .nav-container.nav-open .main-nav {
        display: flex;
        transform: translateY(0);
        height: auto;
        overflow: auto;
      }

      .info-bar {
        flex-direction: column;
        text-align: center;
        padding: 0.5rem 1rem;
        gap: 0.5rem;
      }

      .info-item {
        justify-content: center;
        font-size: 0.75rem;
      }

      .hero-section {
        height: 100vh;
        width: 100%;
        position: relative;
        margin-top: 0;
      }

      .hero-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .hero-overlay {
        width: 100%;
        height: 100%;
      }

      .hero-title {
        font-size: 2rem;
      }

      .hero-subtitle {
        font-size: 0.9rem;
      }

      .hero-content {
        padding: 1rem;
      }

      .hero-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
      }

      .section-title {
        font-size: 1.75rem;
        margin-bottom: 1.5rem;
      }

      .section-text {
        font-size: 0.95rem;
        margin-bottom: 1rem;
        padding: 0 1rem;
      }

      .service-banner {
        height: 150px;
        margin-bottom: 2rem;
      }

      .service-banner h2 {
        font-size: 1.8rem;
        letter-spacing: 2px;
      }

      .service-grid,
      .theme-grid,
      .obituary-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin: 2rem 1rem;
        max-width: 100%;
      }

      .service-card,
      .theme-card,
      .obituary-card {
        border-radius: 12px;
        padding: 1rem;
      }

      .service-image,
      .theme-image {
        height: 180px;
        margin-bottom: 1rem;
      }

      .service-card h3,
      .theme-card h3 {
        font-size: 1.1rem;
      }

      .service-card p,
      .theme-card p,
      .obituary-info p {
        font-size: 0.9rem;
      }

      .obituary-search-container {
        max-width: 100%;
        margin: 0 1rem 1.5rem;
        padding: 0;
      }

      .obituary-search-input {
        font-size: 0.95rem;
        padding: 0.65rem 0.85rem;
      }

      .obituary-name {
        font-size: 1.1rem;
      }

      .obituary-dates {
        font-size: 0.85rem;
      }

      .faq-section {
        padding: 0 1rem;
      }

      .faq-category-title {
        font-size: 1.2rem;
      }

      .faq-chip {
        font-size: 0.85rem;
        padding: 0.6rem 0.8rem;
      }

      .support-buttons {
        flex-direction: column;
        gap: 1rem;
        padding: 1.5rem 1rem;
      }

      .support-btn {
        width: 100%;
        padding: 1rem;
        font-size: 0.95rem;
      }

      .contact-grid {
        padding: 0 1rem;
      }

      .contact-form input,
      .contact-form textarea {
        font-size: 16px;
      }

      .contact-detail {
        padding: 1rem;
        margin: 1rem 0;
      }

      .order-section {
        padding: 3rem 1rem;
      }
    }

    @media (max-width: 480px) {
      .main-nav {
        gap: 0.3rem;
        padding: 0.6rem 0.8rem;
      }

      .main-nav a {
        padding: 0.4rem 0.6rem;
        font-size: 0.7rem;
      }

      .info-bar {
        padding: 0.5rem 0.8rem;
        gap: 0.5rem;
      }

      .info-item {
        font-size: 0.7rem;
      }

      .hero-section {
        height: 100vh;
        width: 100%;
        position: relative;
        margin-top: 0;
      }

      .hero-content {
        padding: 1.5rem 1rem;
      }

      /* Larger hero on small screens for better prominence */
      .hero-logo {
        width: 110px;
        height: 110px;
        margin: 0 auto 1.2rem;
      }

      .hero-title {
        font-size: 3rem;
        margin-bottom: 0.6rem;
        line-height: 1.05;
      }

      .hero-subtitle {
        font-size: 1.15rem;
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
      }

      .section-title {
        font-size: 2.6rem;
        margin-bottom: 1.2rem;
      }

      .section-text {
        font-size: 0.95rem;
        padding: 0 1rem;
        line-height: 1.7;
      }

      .service-banner {
        height: 160px;
        margin-bottom: 2rem;
      }

      .service-banner h2 {
        font-size: 3.6rem;
      }

      .service-grid,
      .theme-grid,
      .obituary-grid,
      .flower-grid {
        margin: 2rem 1rem;
        gap: 1.2rem;
        grid-template-columns: 1fr;
      }

      .service-image,
      .theme-image,
      .flower-image {
        height: 180px;
        margin-bottom: 1rem;
      }

      .service-card h3,
      .theme-card h3,
      .flower-name {
        font-size: 1.1rem;
      }

      .service-card,
      .theme-card,
      .flower-card {
        padding: 1rem;
        border-radius: 16px;
      }

      .flower-price {
        font-size: 1.2rem;
      }

      .obituary-photo {
        height: 220px;
      }

      .obituary-name {
        font-size: 1.1rem;
      }

      .obituary-search-input {
        font-size: 1rem;
        padding: 0.75rem 0.9rem;
      }

      .faq-category-title {
        font-size: 1.2rem;
      }

      .faq-chip {
        font-size: 0.85rem;
        padding: 0.6rem 0.85rem;
      }

      .support-btn {
        padding: 1rem 1.2rem;
        font-size: 0.95rem;
      }

      .contact-form,
      .order-section {
        padding: 1.2rem 1rem;
      }

      .contact-detail {
        padding: 1rem 1.2rem;
        margin: 1rem 0;
      }

      .section {
        padding: 2.5rem 1rem;
      }

      .gold-divider {
        margin: 2rem 0;
      }

      .about-content {
        padding: 0 0.5rem;
      }
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>
  <!-- Chatbot Styles -->
  <style>
    /* FAQ Chatbot styles */
    .faq-chatbot {
      margin: 1rem auto 2rem;
      max-width: 1000px;
      background: #ffffff;
      border: 1px solid rgba(215,154,41,0.3);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .faq-chatbot-header {
      background: #2f4963;
      color: #fff;
      padding: 0.75rem 1rem;
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      letter-spacing: .2px;
    }
    .faq-chatbot-messages {
      max-height: 260px;
      overflow: auto;
      padding: 0.75rem;
      background: #fffaed;
    }
    .faq-chatbot-msg {
      margin: 0.5rem 0;
      padding: 0.6rem 0.8rem;
      border-radius: 10px;
      line-height: 1.5;
      color: #2f4963;
      background: #fff;
      border: 1px solid rgba(47,73,99,.12);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .faq-chatbot-msg.bot {
      background: #2f4963;
      color: #fff;
      border-color: #2f4963;
    }
    .faq-chatbot-msg .source {
      display: block;
      margin-top: 0.35rem;
      font-size: 0.8rem;
      opacity: 0.85;
    }
    .faq-chatbot-input {
      display: flex;
      gap: 0.5rem;
      padding: 0.6rem;
      border-top: 1px solid rgba(47,73,99,.12);
      background: #fff;
    }
    #faqChatInput {
      flex: 1;
      padding: 0.6rem 0.75rem;
      font-size: 0.95rem;
      border: 2px solid #d79a29;
      border-radius: 8px;
      font-family: 'Merriweather', serif;
    }
    #faqChatInput:focus {
      outline: none;
      border-color: #2f4963;
      box-shadow: 0 0 0 3px rgba(47, 73, 99, 0.1);
    }
    #faqChatSend {
      background: #d79a29;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0 1rem;
      font-family: 'Playfair Display', serif;
      cursor: pointer;
    }
    #faqChatSend:hover {
      background: #c28920;
    }
    .faq-chatbot-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.4rem 0.6rem;
      background: #fff;
      border-top: 1px solid rgba(47,73,99,.08);
    }
    .faq-suggest {
      border: 1px solid #d79a29;
      color: #2f4963;
      background: #fff;
      border-radius: 20px;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .faq-suggest:hover {
      background: #d79a29;
      color: #fff;
    }
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }
    @media (max-width: 768px) {
      .faq-chatbot-messages { max-height: 220px; }
    }

    /* Floating Chat Styles */
    .floating-chat-icon {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #d79a29;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10050;
      transition: all 0.3s ease;
      font-size: 28px;
    }

    .floating-chat-icon:hover {
      background: #c28920;
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    .floating-chat-icon.active {
      display: none;
    }

    .floating-chat-box {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 350px;
      height: 500px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 5px 40px rgba(0,0,0,0.16);
      display: none;
      flex-direction: column;
      z-index: 10049;
      overflow: hidden;
    }

    .floating-chat-box.active {
      display: flex;
    }

    .floating-chat-header {
      background: #2f4963;
      color: #fff;
      padding: 1rem;
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #d79a29;
    }

    .floating-chat-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floating-chat-close:hover {
      color: #d79a29;
    }

    .floating-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #fffaed;
    }

    .floating-chat-msg {
      margin-bottom: 0.75rem;
      padding: 0.6rem 0.8rem;
      border-radius: 10px;
      line-height: 1.5;
      font-size: 0.9rem;
      max-width: 85%;
      word-wrap: break-word;
    }

    .floating-chat-msg.user {
      margin-left: auto;
      background: #2f4963;
      color: #fff;
      border: 1px solid #2f4963;
    }

    .floating-chat-msg.bot {
      margin-right: auto;
      background: #fff;
      color: #2f4963;
      border: 1px solid rgba(47,73,99,0.2);
    }

    .floating-chat-msg .source {
      display: block;
      margin-top: 0.4rem;
      font-size: 0.75rem;
      opacity: 0.75;
      font-style: italic;
    }

    .floating-chat-input-area {
      padding: 0.75rem;
      border-top: 1px solid rgba(47,73,99,0.1);
      display: flex;
      gap: 0.5rem;
      background: #fff;
    }

    .floating-chat-input {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #d79a29;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Merriweather', serif;
    }

    .floating-chat-input:focus {
      outline: none;
      border-color: #2f4963;
      box-shadow: 0 0 0 2px rgba(47, 73, 99, 0.1);
    }

    .floating-chat-send {
      background: #d79a29;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }

    .floating-chat-send:hover {
      background: #c28920;
    }

    @media (max-width: 600px) {
      .floating-chat-box {
        width: 90vw;
        height: 80vh;
        max-height: 380px;
        bottom: auto;
        top: 40%;
        left: 50%;
        right: auto;
        transform: translate(-50%, -50%);
      }
      .floating-chat-icon {
        bottom: 1rem;
        right: 1rem;
      }
      .floating-chat-messages {
        max-height: 240px;
        overflow-y: auto;
      }
      .floating-chat-input-area {
        position: sticky;
        bottom: 0;
        padding-bottom: 1.5rem;
        z-index: 100;
      }
      .floating-chat-input { font-size: 1rem; padding: 0.8rem; }
      .floating-chat-send { padding: 0.7rem 1.2rem; font-size: 0.95rem; }
    }

    /* When the chat is active on small screens, keep the floating nav toggle visible
       and move it to the top so it doesn't get hidden by the chat full-screen overlay. */
    @media (max-width: 768px) {
      .chat-active .nav-toggle {
        top: 0.8rem !important;
        bottom: auto !important;
        right: 1rem !important;
        z-index: 10060 !important;
      }
      /* Ensure the nav container sits above the chat where necessary */
      .chat-active .nav-container {
        z-index: 10061 !important;
      }
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper">
   <!-- Navigation -->
   <div class="nav-container">
    <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-label="Toggle navigation">
      <span class="hamburger" aria-hidden="true"></span>
    </button>
    <nav class="main-nav">
      <a href="#home">Homepage</a>
      <a href="#services">Our Services</a>
    
      <a href="#obituaries">Obituaries</a>
      <a href="#support">Grief &amp; Support</a>
      <a href="#faq">FAQs</a>
      <a href="#flowers">Send Flowers &amp; Gifts</a>
      <a href="#contact">Contact Us</a>
      <a href="#order">Inquire Now</a>
    </nav>
    <div class="info-bar">
    <div class="info-item"><span>ðŸ“</span> <span id="address">Unit 204, NLR Center, Gen. T. de Leon, Valenzuela, Metro Manila</span></div>
    <div class="info-item info-phone"><span>ðŸ“ž</span> <span id="phone">0999 604 0668</span></div>
     <div class="info-item"><span>ðŸ•’</span> <span>Open 24/7</span></div>
    </div>
   </div>

   <!-- Hero Section -->
   <section class="hero-section" id="home">
    <!-- HERO VIDEO SOURCE (unchanged) -->
    <video class="hero-video" autoplay muted loop playsinline>
      <source src="herobg1.mp4" type="video/mp4">
    </video>

    <div class="hero-overlay"></div>

    <div class="hero-content">
     <div class="hero-logo">
      <!-- LOGO IMAGE -->
      <img src="logo.png" alt="Solara Farewell Logo">
     </div>
     <h1 class="hero-title" id="hero-title">Solara Farewell</h1>
     <p class="hero-subtitle" id="hero-subtitle">Finding peace in the light of life well-lived.</p>
    </div>
   </section>

   <!-- Gold Divider -->
   <div class="gold-divider"></div>

   <!-- About Section -->
   <section class="section section-dark" id="about">
    <div class="about-content">
     <h2 class="section-heading" id="history-title">Our History</h2>
     <p class="section-text">Solara Farewell was founded with a vision to provide compassionate and dignified memorial services to families during their most difficult times. Our journey began decades ago when our founder recognized the need for a funeral service that truly honors the lives of loved ones while providing comfort and support to grieving families.</p>
     <p class="section-text">Through the years, we have served countless families with dedication, respect, and unwavering commitment. We understand that each life is unique, and we strive to create personalized farewell ceremonies that reflect the individual spirit of those we honor.</p>
     <p class="section-text">Today, Solara Farewell stands as a trusted name in memorial services, combining traditional values with modern amenities to serve our community with excellence and compassion.</p>
     <div class="gold-divider"></div>
     <h2 class="section-heading" id="vision-title">Our Vision</h2>
     <p class="section-text">To be the most trusted and compassionate memorial service provider, creating meaningful farewell experiences that bring comfort, peace, and healing to every family we serve, while honoring the dignity and memory of their loved ones.</p>
     <div class="gold-divider"></div>
     <h2 class="section-heading" id="mission-title">Our Mission</h2>
     <p class="section-text">Solara Farewell honors every life with compassionate, respectful care and innovative memorial services that help families celebrate life and find comfort in every farewell.</p>
     <div class="gold-divider"></div>
     <h2 class="section-heading" id="cert-title">Certifications & Permits</h2>
     <p class="section-text">Solara Farewell is fully licensed and certified to operate as a professional funeral and memorial service provider. Our certifications and permits demonstrate our commitment to maintaining the highest standards of service and care. <a href="javascript:openCertificatesModal()" style="color: #d79a29; text-decoration: underline; cursor: pointer; font-weight: bold;">Click here to view our certificates and permits</a></p>
    </div>
   </section>

   <!-- Services Section -->
   <section class="section" id="services">
    <div class="service-banner" style="background-image: url('titlebg.jpg'); background-size: cover; background-position: center;">
    <h2 style="color: #2f4963;">Our Services</h2>
  </div>
  
  <!-- Rooms (match Burial/Cremation card style) -->
  <section class="section" id="rooms">
<h2 class="section-heading" style="text-align: center; color: #2f4963;">Rooms</h2>
    <div class="service-grid">
      <div class="service-card">
        <div class="service-image room-basic"></div>
        <h3 style="color: rgb(198, 159, 18)">Basic Room</h3>
        <p>Cozy private space for intimate gatherings. Capacity: 20 paccs.</p>
        <ul class="room-includes">
          <li>Fresh flower arrangements</li>
          <li>Floor carpets and runners</li>
          <li>Decorative candles</li>
          <li>Standard seating layout (20)</li>
        </ul>
        <button class="show-more-btn" onclick="openRoomBooking('room-basic')">Book Now</button>
      </div>
      <div class="service-card">
        <div class="service-image room-premium"></div>
        <h3 style="color: rgb(198, 159, 18)">Premium Room</h3>
        <p>Upgraded amenities and decor. Capacity: 20 paccs.</p>
        <ul class="room-includes">
          <li>Premium flower centerpieces</li>
          <li>Luxury carpets and stage runner</li>
          <li>Fancy candles and elevated lighting</li>
          <li>Enhanced seating & basic AV setup</li>
        </ul>
        <button class="show-more-btn" onclick="openRoomBooking('room-premium')">Book Now</button>
      </div>
      <div class="service-card">
        <div class="service-image room-deluxe"></div>
        <h3 style="color: rgb(198, 159, 18)">Deluxe Room</h3>
        <p>Spacious hall with premium services and catering options. Capacity: 20 paccs.</p>
        <ul class="room-includes">
          <li>Full floral package</li>
          <li>High-end carpets and runners</li>
          <li>Designer candles and ambient lighting</li>
          <li>Full AV, seating, and catering coordination</li>
        </ul>
        <button class="show-more-btn" onclick="openRoomBooking('room-deluxe')">Book Now</button>
      </div>
    </div>
  </section>

    <h2 class="section-heading" style="text-align: center; color: #2f4963;">Burial Services</h2>
    <div class="service-grid">
    <div class="service-card">
     <div class="service-image burial-basic"></div>
     <h3 style="color: rgb(198, 159, 18)">Basic Burial</h3>
     <p>Affordable and dignified burial service with essential arrangements for your loved one.</p>
     <button class="show-more-btn" onclick="openGallery('burial-basic')">Show More Designs</button>
    </div>
    <div class="service-card">
     <div class="service-image burial-premium"></div>
     <h3 style="color: rgb(198, 159, 18)">Premium Burial</h3>
     <p>Enhanced burial package with premium casket options and personalized memorial service.</p>
     <button class="show-more-btn" onclick="openGallery('burial-premium')">Show More Designs</button>
    </div>
    <div class="service-card">
     <div class="service-image burial-deluxe"></div>
     <h3 style="color: rgb(198, 159, 18);">Deluxe Burial</h3>
     <p>Our most comprehensive burial service with luxury casket and full ceremonial arrangements.</p>
     <button class="show-more-btn" onclick="openGallery('burial-deluxe')">Show More Designs</button>
    </div>
    </div>

    <h3 class="section-heading" style="text-align: center; color: #2f4963; margin-top: 3rem;">Cremation Services</h3>
    <div class="service-grid">
    <div class="service-card">
     <div class="service-image crem-basic"></div>
     <h3 style="color: rgb(198, 159, 18)">Basic Cremation</h3>
      <p>Simple and respectful cremation service with standard memorial options.</p>
      <button class="show-more-btn" onclick="openGallery('crem-basic')">Show More Designs</button>
     </div>
     <div class="service-card">
      <div class="service-image crem-memorial"></div>
     <h3 style="color: rgb(198, 159, 18)">Memorial Cremation</h3>
      <p>Cremation service with memorial ceremony and premium urn selection.</p>
      <button class="show-more-btn" onclick="openGallery('crem-memorial')">Show More Designs</button>
     </div>
     <div class="service-card">
      <div class="service-image crem-premium"></div>
     <h3 style="color: rgb(198, 159, 18)">Premium Cremation</h3>
      <p>Complete cremation package with elaborate memorial service and luxury urn.</p>
      <button class="show-more-btn" onclick="openGallery('crem-premium')">Show More Designs</button>
     </div>
    </div>

    <h3 class="section-heading" style="text-align: center; color: #2f4963; margin-top: 3rem;">Online Memorial</h3>

    <div class="service-grid">
      <div class="service-card">
        <div class="service-image online-eburo"></div>
        <h3>Solara e-Burol</h3>
        <p>Live streaming memorial service allowing family and friends to participate remotely from anywhere in the world.</p>
        <button class="show-more-btn" onclick="openOnlineModal()">Learn More</button>
      </div>
    </div>
   </section>



   <!-- Obituaries Section -->
   <section class="section" id="obituaries">
    <h2 class="section-title">Recent Obituaries</h2>
    <div class="obituary-search-container">
      <input type="text" class="obituary-search-input" id="obituarySearch" placeholder="Search by name...">
    </div>
    <div class="obituary-grid" id="obituaryGrid">
     <!-- OBITUARY CARD: Asis, Fortunato - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
     <div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122104625049113745&id=61583412373497&rdid=nMUeZ1LdpLxMNhtH#">
      <div class="obituary-photo obit-asis"></div>
      <div class="obituary-info">
       <h3 class="obituary-name">Asis, Fortunato</h3>
       <p class="obituary-dates">1945 - 2024</p>
      </div>
     </div>
     <!-- OBITUARY CARD: Baltazar, Antonio - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
     <div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122104624023113745&id=61583412373497&rdid=s75fWU0gKARmJ0la#">
      <div class="obituary-photo obit-baltazar"></div>
      <div class="obituary-info">
       <h3 class="obituary-name">Baltazar, Antonio</h3>
       <p class="obituary-dates">1952 - 2024</p>
      </div>
     </div>
     <!-- OBITUARY CARD: Alicarte, Claudio - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
     <div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122104619529113745&id=61583412373497&rdid=Hp7559DOX5s80JaO#">
      <div class="obituary-photo obit-alicarte"></div>
      <div class="obituary-info">
       <h3 class="obituary-name">Alicarte, Claudio</h3>
       <p class="obituary-dates">1948 - 2024</p>
      </div>
     </div>
     <!-- OBITUARY CARD: Cruz, Marcelina - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
     <div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122105178753113745&id=61583412373497&rdid=eTqbVmNDsYhj8IrA#">
      <div class="obituary-photo obit-cruz"></div>
      <div class="obituary-info">
       <h3 class="obituary-name">Cruz, Marcelina</h3>
       <p class="obituary-dates">1941 - 2024</p>
      </div>
     </div>
     <!-- OBITUARY CARD: Merly Espiranza - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
<div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122107933221113745&id=61583412373497&rdid=vRSXjBmK3OUP5bA0#">
  <div class="obituary-photo" style="background-image: url('obit-merly.jpg');"></div>
  <div class="obituary-info">
    <h3 class="obituary-name">Espiranza, Merly</h3>
    <p class="obituary-dates">1962 â€“ 2023</p>
  </div>
</div>

<!-- OBITUARY CARD: Marilyn Avellana - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
<div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122107932693113745&id=61583412373497&rdid=BMp1LpQ9M02Ms0fo#">
  <div class="obituary-photo" style="background-image: url('obit-marilyn.jpg');"></div>
  <div class="obituary-info">
    <h3 class="obituary-name">Avellana, Marilyn</h3>
    <p class="obituary-dates">1967 â€“ 2025</p>
  </div>
</div>

<!-- OBITUARY CARD: Crisanta Sumabat - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
<div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122107933515113745&id=61583412373497&rdid=Y1razY9kkzeenHWv#">
  <div class="obituary-photo" style="background-image: url('obit-crisanta.jpg');"></div>
  <div class="obituary-info">
    <h3 class="obituary-name">Sumabat, Crisanta</h3>
    <p class="obituary-dates">1948 â€“ 2025</p>
  </div>
</div>

<!-- OBITUARY CARD: Louisito Manuel - PASTE FACEBOOK POST LINK IN data-fb-link ATTRIBUTE BELOW -->
<div class="obituary-card" data-fb-link="https://www.facebook.com/story.php?story_fbid=122107932273113745&id=61583412373497&rdid=lB4gFw424NeKCkyv#">
  <div class="obituary-photo" style="background-image: url('obit-louisito.jpg');"></div>
  <div class="obituary-info">
    <h3 class="obituary-name">Manuel, Louisito</h3>
    <p class="obituary-dates">1980 â€“ 2023</p>
  </div>
</div>


    </div>
    <div id="obituaryPagination" class="pagination" aria-label="Obituary pagination"></div>

     </section>

    
    <section class="section section-dark" id="support">
  <div class="service-banner" style="background-image: url('titlebg.jpg'); background-size: cover; background-position: center;">
    <h2 style="color: #e29b01;">Grief &amp; Support</h2>
  </div>

  <!-- ðŸ”µ INSERT THIS TEXT HERE -->
  <p class="section-text" style="text-align:center; max-width:900px; margin:0 auto 2rem;">
     At Solara Farewell, we want families to feel supported even after the funeral has ended. We recognize that grief is a gradual process and that each person experiences it differently. Because of this, we provide grief support and a range of resources to assist you during the challenging period that follows a loss.
  </p>

  <p class="section-text" style="text-align:center; max-width:900px; margin:0 auto 3rem;">
    Our support services are designed to offer comfort and clear guidance whenever you need it.
    We can connect you with professional counselors, established support groups, and reliable
    information that may help you better understand and manage your emotions.
  </p>
  <!-- ðŸ”µ END OF INSERT -->

    <div class="support-buttons">
      <a href="https://find.griefshare.org/countries/ph" 
        class="support-btn" 
        target="_blank" 
        rel="noopener noreferrer">
        Grief Share
      </a>
      
      <a href="https://www.pmha.org.ph/" 
         class="support-btn" 
         target="_blank" 
         rel="noopener noreferrer">
         PMHA
      </a>
      <a href="https://mentalhealthph.org/" class="support-btn" target="_blank" rel="noopener noreferrer">
         Online Materials &amp; Contacts
      </a>
    </div>
   </section>

   <!-- FAQ Section -->
   <section class="section" id="faq">
    <h2 class="section-title">Frequently Asked Questions</h2>
    <div class="faq-section">
     <div class="faq-category">
      <h3 class="faq-category-title">Cremation FAQs</h3>
      <div class="faq-chips">
       <div class="faq-item">
        <div class="faq-chip">How much does cremation cost?</div>
        <div class="faq-answer">
          Costs depend on the package you choose, the urn, and any ceremonies included. We can provide simple options for tight budgets and more complete packages with services and flowers.
        </div>
       </div>
       


       <div class="faq-item">
        <div class="faq-chip">Is cremation a funeral substitute?</div>
        <div class="faq-answer">
          Cremation is the method of handling the body, not the service itself. You can still have a viewing, memorial, or religious ceremony before or after the cremation.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">When is the service held?</div>
        <div class="faq-answer">
          Services may be held before cremation, after cremation with the urn present, or both. The schedule is based on your familyâ€™s preferences and the availability of venues and clergy.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Can we rent a casket?</div>
        <div class="faq-answer">
          Yes. Many families choose a rental casket for viewing or ceremonies, and then use a simpler container for the actual cremation to help manage costs.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Is there a crematory available?</div>
        <div class="faq-answer">
          We coordinate with trusted partner crematories that follow strict standards and documentation. Our team handles all arrangements and paperwork for you.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Why is a place to visit important?</div>
        <div class="faq-answer">
          A permanent place, such as a columbarium, cemetery, or memorial area, gives family and friends somewhere to visit, reflect, and honor memories in the years to come.
        </div>
       </div>
      </div>
     </div>

     <div class="faq-category">
      <h3 class="faq-category-title">Arranging a Service FAQs</h3>
      <div class="faq-chips">
       <div class="faq-item">
        <div class="faq-chip">What to do when death occurs?</div>
        <div class="faq-answer">
          Contact us or your chosen funeral home as soon as possible. We will guide you step-by-step, arrange the transfer of your loved one, and help you complete the necessary documents.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">What service fits our needs?</div>
        <div class="faq-answer">
          We first listen to your wishes, traditions, and budget. From there, we suggest optionsâ€”such as simple gatherings, full religious rites, or memorial servicesâ€”that best match your family.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Should children attend?</div>
        <div class="faq-answer">
          Children may attend if they are prepared gently and supported by adults. Saying goodbye can help them understand loss, but it should always respect their age, comfort, and consent.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Can we plan ahead?</div>
        <div class="faq-answer">
          Yes. Pre-planning allows you to record your wishes and secure services in advance. This lessens emotional and financial stress for your family when the time comes.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Burial or cremation?</div>
        <div class="faq-answer">
          The choice depends on religious beliefs, personal preferences, and budget. We will explain the differences, costs, and options so your family can make an informed decision together.
        </div>
       </div>

       <div class="faq-item">
        <div class="faq-chip">Can we view the remains?</div>
        <div class="faq-answer">
          In most cases, yes. A viewing or last visit can give family and friends an opportunity for closure. We prepare your loved one with care and respect, following your wishes.
        </div>
       </div>
      </div>
     </div>
    </div>
   </section>

   <!-- Flowers Section -->
   <section class="section section-dark" id="flowers">
    <h2 class="section-title">Blooms<
       <span style="font-family: 'Merriweather', serif; font-size: 2rem;">by</span> Marra</h2>
    <div class="flower-grid">
     <div class="flower-card">
      <div class="flower-image flowers-serene"></div>
      <h3 class="flower-name">Serene Blooms</h3>
      <p class="flower-price">â‚±999</p>
     </div>
     <div class="flower-card">
      <div class="flower-image flowers-golden"></div>
      <h3 class="flower-name">Golden Light</h3>
      <p class="flower-price">â‚±999</p>
     </div>
     <div class="flower-card">
      <div class="flower-image flowers-radiance"></div>
      <h3 class="flower-name">Gentle Radiance</h3>
      <p class="flower-price">â‚±1,499</p>
     </div>
     <div class="flower-card">
      <div class="flower-image flowers-eternal"></div>
      <h3 class="flower-name">Eternal Blooms</h3>
      <p class="flower-price">â‚±2,499</p>
     </div>
     <div class="flower-card">
      <div class="flower-image flowers-remember"></div>
      <h3 class="flower-name">Remembering Set</h3>
      <p class="flower-price">Custom Pricing</p>
     </div>
    </div>
    <div class="section-text" style="text-align: center; margin-top: 2rem;">
     <p><strong>Contact Blooms by Marra:</strong></p>
     <p>ðŸ“ž 0999 604 0668
       |âœ‰ï¸ blooms@marra.com</p>
     <p>Available for same-day delivery across Metro Manila</p>
    </div>
   </section>

   <!-- Contact Section -->
   <section class="section" id="contact">
    <h2 class="section-title">Contact Us</h2>
    <div class="contact-grid">
     <div class="contact-form">
      <form action="https://formspree.io/f/xnnevvrv" method="POST" id="contactForm">
       <div  class="form-group">
        <label for="name" class="form-label">Your Name</label>
        <input type="text" id="name" name="name" class="form-input" required>
       </div>
       <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" name="email" id="email" class="form-input" required>
       </div>
      <div class="form-group">
       <label for="message" class="form-label">Message</label>
       <textarea id="message" name="message" class="form-textarea" required></textarea>
      </div>
       <button type="submit" class="submit-btn">Submit Message</button>
       <p class="privacy-note">Your information is secure and will only be used to respond to your inquiry.</p>
      </form>
     </div>
     <div class="contact-info">
      <div class="contact-detail">
       <h3 class="contact-detail-label">24/7 Availability</h3>
       <p>We are here for you anytime, day or night. Our compassionate team is always ready to assist you.</p>
      </div>
      <div class="contact-detail">
       <h3 class="contact-detail-label">Phone</h3>
       <p id="contact-phone">0999 604 0668</p>
      </div>
      <div class="contact-detail">
       <h3 class="contact-detail-label">Email</h3>
       <p id="contact-email">contact@solarafarewell.com</p>
      </div>
      <div class="contact-detail">
       <h3 class="contact-detail-label">Location</h3>
       <p id="contact-address">Unit 204, NLR Center, Gen. T. de Leon, Valenzuela, Metro Manila</p>
      </div>
      <div class="contact-detail">
       <h3 class="contact-detail-label">Payments</h3>
       <p>For payments, please visit our physical store at Unit 204, NLR Center, Gen. T. de Leon, Valenzuela, Metro Manila.</p>
      </div>
      <div class="contact-detail">
       <h3 class="contact-detail-label">Follow Us</h3>
       <div class="social-links">
        <a href="https://www.facebook.com/profile.php?id=61583234740899&rdid=lHEGdz5qwHUUm6IU&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F19o9ocWxQy" target="_blank" rel="noopener noreferrer" class="social-link" title="Follow us on Facebook">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#d79a29" width="32" height="32">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </a>
        <a href="https://www.instagram.com/solarafarewell/" target="_blank" rel="noopener noreferrer" class="social-link" title="Follow us on Instagram">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#d79a29" width="32" height="32">
            <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.117.63c-.694.272-1.279.645-1.863 1.229-.584.584-.957 1.169-1.229 1.863-.297.788-.5 1.658-.56 2.935C.015 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.263 2.148.56 2.935.272.694.645 1.279 1.229 1.863.584.584 1.169.957 1.863 1.229.788.297 1.658.5 2.935.56 1.28.058 1.687.072 4.947.072s3.667-.015 4.947-.072c1.277-.06 2.148-.263 2.935-.56.694-.272 1.279-.645 1.863-1.229.584-.584.957-1.169 1.229-1.863.297-.788.5-1.658.56-2.935.058-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.263-2.148-.56-2.935-.272-.694-.645-1.279-1.229-1.863-.584-.584-1.169-.957-1.863-1.229-.788-.297-1.658-.5-2.935-.56C15.667.015 15.26 0 12 0zm0 2.16c3.203 0 3.585.009 4.849.07 1.171.054 1.805.244 2.227.408.56.217.96.477 1.382.896.419.42.679.822.896 1.381.164.422.354 1.057.408 2.227.061 1.264.07 1.646.07 4.849s-.009 3.585-.07 4.849c-.054 1.171-.244 1.805-.408 2.227-.217.56-.477.96-.896 1.382-.42.419-.822.679-1.381.896-.422.164-1.057.354-2.227.408-1.264.061-1.646.07-4.849.07s-3.585-.009-4.849-.07c-1.171-.054-1.805-.244-2.227-.408-.56-.217-.96-.477-1.382-.896-.419-.42-.679-.822-.896-1.381-.164-.422-.354-1.057-.408-2.227-.061-1.264-.07-1.646-.07-4.849s.009-3.585.07-4.849c.054-1.171.244-1.805.408-2.227.217-.56.477-.96.896-1.382.42-.419.822-.679 1.381-.896.422-.164 1.057-.354 2.227-.408 1.264-.061 1.646-.07 4.849-.07zM5.838 12a6.162 6.162 0 1 1 12.324 0 6.162 6.162 0 0 1-12.324 0zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm4.965-10.322a1.44 1.44 0 1 1 2.881.001 1.44 1.44 0 0 1-2.881-.001z"/>
          </svg>
        </a>
       </div>
      </div>
     </div>
    </div>

    <div class="map-placeholder" style="width:100%; max-width:900px; margin:0 auto;">
      <iframe
        src="https://www.google.com/maps?q=14.687925534939481,120.99889445252761&z=17&output=embed"
        width="100%" height="340" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
   </section>

   <!-- Order Section -->
  <section class="order-section" id="order">
   <a href="#services" class="order-btn" role="button">Inquire Now</a>
   <p class="section-text" style="margin-top:1rem">Contact us today to begin planning a meaningful farewell for your loved one. Our dedicated team is ready to guide you through every step with compassion and care.</p>
  </section>
  </div>

  <!-- Design Gallery Modal -->
  <div id="designModal" class="design-modal">
    <div class="design-box">
      <span class="close-btn" onclick="closeGallery()">âœ•</span>
      <h2 id="designTitle">Design Gallery</h2>
      <div id="designGrid" class="design-grid"></div>
      <div style="margin-top:1rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap;">
        <button id="designLearnMore" class="show-more-btn" style="display:none;">Learn More</button>
        <button class="show-more-btn" onclick="closeGallery()" style="background:white; color:#2f4963;">Close</button>
      </div>
    </div>
  </div>

  <!-- Booking Modal -->
  <div id="bookingModal" class="booking-modal" aria-hidden="true">
    <div class="booking-box" role="dialog" aria-modal="true" aria-labelledby="bookingTitle">
      <div class="booking-header">
        <h3 id="bookingTitle">Book Room</h3>
        <button class="close-btn" onclick="closeBooking()">âœ•</button>
      </div>
      <div id="bookingInfo" style="text-align:center; color:#415b6d;"></div>
      <div style="display:flex; gap:0.5rem; justify-content:center; align-items:center;">
        <button type="button" id="calPrev" class="show-more-btn" style="background:#fff; color:#2f4963;">â—€</button>
        <div id="calMonthLabel" style="min-width:160px; text-align:center; font-weight:600"></div>
        <button type="button" id="calNext" class="show-more-btn" style="background:#fff; color:#2f4963;">â–¶</button>
      </div>
      <div style="text-align:center; margin-top:0.6rem;">
        <label for="bookingDuration" style="font-size:0.95rem; color:#415b6d; margin-right:0.5rem;">Days:</label>
        <select id="bookingDuration" style="padding:6px 8px; border-radius:6px; border:1px solid #dcdcdc;">
          <option value="1">1 day</option>
          <option value="2">2 days</option>
          <option value="3">3 days</option>
          <option value="4">4 days</option>
          <option value="5">5 days</option>
          <option value="6">6 days</option>
          <option value="7">7 days</option>
        </select>
      </div>
      <div style="text-align:center; margin-top:0.6rem;">
        <label for="bookingSurname" style="font-size:0.95rem; color:#415b6d; margin-right:0.5rem;">Surname / Family name:</label>
        <input id="bookingSurname" type="text" placeholder="e.g. Garcia" style="padding:6px 8px; border-radius:6px; border:1px solid #dcdcdc; width:160px;" />
      </div>
      <div id="bookingCalendar" class="booking-calendar" style="margin-top:0.75rem; display:grid; gap:6px; grid-template-columns: repeat(7,1fr); text-align:center; flex-shrink:0;"></div>
      <div id="bookedList" style="text-align:center; font-size:0.9rem; color:#2f4963; margin-top:0.5rem; padding:0.5rem; border-radius:8px; background:#f9f9f9;"></div>
      <div class="booking-actions">
        <button id="confirmBook" class="show-more-btn">Reserve Now</button>
        <button class="show-more-btn" onclick="closeBooking()" style="background:white; color:#2f4963;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Online e-Burol Modal -->
  <div id="onlineModal" class="design-modal">
    <div class="design-box">
      <span class="close-btn" onclick="closeOnlineModal()">âœ•</span>
      <h2>Solara e-Burol</h2>
      <p style="margin-top:0.5rem;">Our Solara e-Burol service allows family and friends to join memorials remotely via live streaming. Click below to continue to our online viewing experience.</p>
      <div style="margin-top:1rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap;">
        <a href="https://www.canva.com/design/DAG5ZIsUDv4/0abZNF7ZXTtkBspoYFmjjA/view?utlId=h9caa600126#2"  class="show-more-btn">Continue to e-Burol</a>
        <button class="show-more-btn" onclick="closeOnlineModal()" style="background:white; color:#2f4963;">Close</button>
      </div>
    </div>
  </div>

  <!-- Certificates & Permits Modal -->
  <div id="certificatesModal" class="design-modal">
    <div class="design-box">
      <span class="close-btn" onclick="closeCertificatesModal()">âœ•</span>
      <h2>Certificates & Permits</h2>
      <p style="margin-top:0.5rem; margin-bottom:1rem;">Below are our official certifications and permits that validate our authority and commitment to professional funeral services.</p>
      <div id="certificatesGrid" class="design-grid">
        <!-- Certificate images (user-provided). Files should be next to this HTML file or adjust paths as needed -->
        <div>
          <img src="cert1.jpeg" alt="Professional Funeral Services License">
        </div>
        <div>
          <img src="cert2.jpeg" alt="Business Operating Permit">
        </div>
        <div>
          <img src="cert3.jpeg" alt="Health & Safety Certification">
        </div>
      </div>
      
      <div style="margin-top:1rem; display:flex; gap:0.75rem; justify-content:center; flex-wrap:wrap;">
        <button class="show-more-btn" onclick="closeCertificatesModal()" style="background:white; color:#2f4963;">Close</button>
      </div>
    </div>
  </div>

  <!-- Image lightbox -->
  <div id="imgLightbox" class="img-lightbox" onclick="closeLightbox(event)">
    <span class="lb-close" onclick="closeLightbox(event)">Close âœ•</span>
    <img id="lbImage" src="" alt="Certificate" />
  </div>

  <script>
    const defaultConfig = {
      hero_title: "Solara Farewell",
      hero_subtitle: "Finding peace in the light of a life well-lived.",
      address_text: "Unit 204, NLR Center, Gen. T. de Leon, Valenzuela, Metro Manila",
      phone_number: "0999 604 0668",
      email_address: "contact@solarafarewell.com",
      history_title: "Our History",
      vision_title: "Our Vision",
      mission_title: "Our Mission",
      background_color: "#2f4963",
      accent_color: "#d79a29",
      surface_color: "#ffffff",
      text_color: "#2f4963",
      secondary_surface_color: "#3a6082"
    };

    // Apply config from editor (colors, text, contact)
    async function onConfigChange(config) {
      const heroTitle = config.hero_title || defaultConfig.hero_title;
      const heroSubtitle = config.hero_subtitle || defaultConfig.hero_subtitle;
      const addressText = config.address_text || defaultConfig.address_text;
      const phoneNumber = config.phone_number || defaultConfig.phone_number;
      const emailAddress = config.email_address || defaultConfig.email_address;
      const historyTitle = config.history_title || defaultConfig.history_title;
      const visionTitle = config.vision_title || defaultConfig.vision_title;
      const missionTitle = config.mission_title || defaultConfig.mission_title;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const secondarySurfaceColor = config.secondary_surface_color || defaultConfig.secondary_surface_color;

      document.getElementById('hero-title').textContent = heroTitle;
      document.getElementById('hero-subtitle').textContent = heroSubtitle;
      document.getElementById('address').textContent = addressText;
      document.getElementById('phone').textContent = phoneNumber;
      document.getElementById('contact-phone').textContent = phoneNumber;
      document.getElementById('contact-email').textContent = emailAddress;
      document.getElementById('history-title').textContent = historyTitle;
      document.getElementById('vision-title').textContent = visionTitle;
      document.getElementById('mission-title').textContent = missionTitle;

      document.documentElement.style.setProperty('--background-color', backgroundColor);
      document.documentElement.style.setProperty('--accent-color', accentColor);
      document.documentElement.style.setProperty('--surface-color', surfaceColor);
      document.documentElement.style.setProperty('--text-color', textColor);
      document.documentElement.style.setProperty('--secondary-surface-color', secondarySurfaceColor);

      const darkSections = document.querySelectorAll('.section-dark');
      darkSections.forEach(section => {
        section.style.backgroundColor = backgroundColor;
      });

      const navContainer = document.querySelector('.nav-container');
      navContainer.style.backgroundColor = backgroundColor;

      const infoBar = document.querySelector('.info-bar');
      infoBar.style.backgroundColor = secondarySurfaceColor;

      const accentElements = document.querySelectorAll('.section-title, .hero-title, .hero-logo-text, .gold-divider, .section-heading, .contact-detail-label, .order-title, .theme-price, .flower-price, .casket-price');
      accentElements.forEach(el => {
        el.style.color = accentColor;
      });

      const goldDividers = document.querySelectorAll('.gold-divider');
      goldDividers.forEach(divider => {
        divider.style.backgroundColor = accentColor;
      });

      const serviceCards = document.querySelectorAll('.service-card, .theme-card, .flower-card, .casket-card, .obituary-card, .contact-info');
      serviceCards.forEach(card => {
        card.style.backgroundColor = surfaceColor;
      });

      const textElements = document.querySelectorAll('.section-text, .service-card h3, .theme-name, .flower-name, .casket-title, .obituary-name, .faq-category-title');
      textElements.forEach(el => {
        el.style.color = textColor;
      });

      const heroLogo = document.querySelector('.hero-logo');
      heroLogo.style.borderColor = accentColor;

      const supportBtns = document.querySelectorAll('.support-btn');
      supportBtns.forEach(btn => {
        btn.style.backgroundColor = accentColor;
      });

      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.style.backgroundColor = backgroundColor;

      const faqChips = document.querySelectorAll('.faq-chip');
      faqChips.forEach(chip => {
        chip.style.borderColor = accentColor;
        chip.style.color = textColor;
      });
    }

    // Map editor capabilities (recolorables, borders, fonts)
    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.secondary_surface_color || defaultConfig.secondary_surface_color,
            set: (value) => {
              config.secondary_surface_color = value;
              window.elementSdk.setConfig({ secondary_surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => {
              config.accent_color = value;
              window.elementSdk.setConfig({ accent_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    // Prepare values shown in the edit panel (fields)
    function mapToEditPanelValues(config) {
      return new Map([
        ["hero_title", config.hero_title || defaultConfig.hero_title],
        ["hero_subtitle", config.hero_subtitle || defaultConfig.hero_subtitle],
        ["address_text", config.address_text || defaultConfig.address_text],
        ["phone_number", config.phone_number || defaultConfig.phone_number],
        ["email_address", config.email_address || defaultConfig.email_address],
        ["history_title", config.history_title || defaultConfig.history_title],
        ["vision_title", config.vision_title || defaultConfig.vision_title],
        ["mission_title", config.mission_title || defaultConfig.mission_title]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Obituary search
    const searchInput = document.getElementById('obituarySearch');
    const obituaryCards = document.querySelectorAll('.obituary-card');

    if (searchInput) {
      searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        obituaryCards.forEach(card => {
          const name = card.querySelector('.obituary-name').textContent.toLowerCase();
          if (name.includes(searchTerm)) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
        // update pagination after filtering
        updateObituaryPagination && updateObituaryPagination();
      });
    }

    // Add click handler to obituary cards to redirect to Facebook post
    document.querySelectorAll('.obituary-card[data-fb-link]').forEach(card => {
      card.addEventListener('click', function() {
        const fbLink = this.getAttribute('data-fb-link');
        if (fbLink && fbLink !== 'https://www.facebook.com/') {
          window.open(fbLink, '_blank');
        } else {
          alert('Facebook post link not yet configured for this obituary. Please contact us for more information.');
        }
      });
    });

    // Smooth scroll
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    // FAQ dropdown logic
    // Toggle FAQ answer when a chip is clicked (show/hide)
    document.querySelectorAll('.faq-chip').forEach(chip => {
      // Event handler for toggling each FAQ item
      chip.addEventListener('click', function () {
        const answer = this.nextElementSibling;
        if (!answer || !answer.classList.contains('faq-answer')) return;
        const visible = answer.style.display === 'block';
        answer.style.display = visible ? 'none' : 'block';
      });
    });

    /*
      GALLERY_DESIGNS
      Edit the image lists below directly in the code to change which images show
      for each package. Each key maps to an object with `title` and `images`.
      Example: change 'casket-basic-1.jpg' to your own filename.
    */
    const GALLERY_DESIGNS = {
      'burial-basic': {
        title: 'Casket Designs â€” Basic',
        images: ['casket-basic-1.jpg', 'casket-basic-2.jpg', 'casket-basic-3.png']
      },
      'burial-premium': {
        title: 'Casket Designs â€” Premium',
        images: ['casket-premium-1.jpg', 'casket-premium-2.jpeg', 'casket-premium-3.jpeg']
      },
      'burial-deluxe': {
        title: 'Casket Designs â€” Deluxe',
        images: ['casket-deluxe-1.jpg', 'casket-deluxe-2.jpg', 'casket-deluxe-3.png']
      },
      'crem-basic': {
        title: 'Urn Designs â€” Basic',
        images: ['urn-basic-1.png', 'urn-basic-2.png', 'urn-basic-3.png']
      },
      'crem-memorial': {
        title: 'Urn & Memorial Designs',
        images: ['urn-memorial-1.png', 'urn-memorial-2.png', 'urn-memorial-3.png']
      },
      'crem-premium': {
        title: 'Urn Designs â€” Premium',
        images: ['urn-premium-1.png', 'urn-premium-2.png', 'urn-premium-3.png']
      }
    };

    // Open design gallery modal for a package type
    function openGallery(type) {
      const modal = document.getElementById('designModal');
      const title = document.getElementById('designTitle');
      const grid = document.getElementById('designGrid');

      grid.innerHTML = '';

      const cfg = GALLERY_DESIGNS[type];
      let designs = [];
      if (cfg) {
        title.textContent = cfg.title || 'Designs';
        designs = cfg.images || [];
      } else {
        title.textContent = 'Designs';
        designs = ['placeholder1.jpg', 'placeholder2.jpg', 'placeholder3.jpg'];
      }

      designs.forEach((src, idx) => {
        const storageKey = `gallery_override_${type}_${idx}`;
        const override = localStorage.getItem(storageKey);
        const finalSrc = override || src;

        const div = document.createElement('div');
        div.className = 'design-item';
        div.style.backgroundImage = `url('${finalSrc}')`;
        div.dataset.index = idx;
        div.dataset.type = type;

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.type = 'button';
        editBtn.textContent = 'Edit';
        editBtn.onclick = function(e) {
          e.stopPropagation();
          openDesignEditor(div, type, idx, src);
        };
        div.appendChild(editBtn);

        grid.appendChild(div);
      });

      modal.style.display = 'flex';

      const learnMore = document.getElementById('designLearnMore');
      if (learnMore) {
        if (type.includes('burial')) {
          learnMore.style.display = 'inline-block';
          learnMore.onclick = function() {
            window.open('https://www.canva.com/design/DAG55tcCtvw/5l_HPCfMk1BDF-h9VGEesA/view?utlId=hda4192706a', '_blank');
          };
        } else if (type.includes('crem')) {
          learnMore.style.display = 'inline-block';
          learnMore.onclick = function() {
            window.open('https://www.canva.com/design/DAG534bpAdQ/SVYfI4j2fleoNJQJkYwWHA/watch?utlId=h6c8509e977', '_blank');
          };
        } else {
          learnMore.style.display = 'none';
          learnMore.onclick = null;
        }
      }
    }

    /* Room booking data + UI handlers */
    function _loadBookings() {
      try {
        return JSON.parse(localStorage.getItem('room_bookings') || '{}');
      } catch (e) {
        return {};
      }
    }

    function _saveBookings(obj) {
      localStorage.setItem('room_bookings', JSON.stringify(obj));
    }

    /* Owners metadata (localStorage-only). Keeps ownerId/ownerName per category+date
       This is separate from the simple array used for Firestore compatibility. */
    function _loadBookingOwners(){
      try { return JSON.parse(localStorage.getItem('room_booking_owners') || '{}'); } catch(e){ return {}; }
    }
    function _saveBookingOwners(obj){
      try { localStorage.setItem('room_booking_owners', JSON.stringify(obj)); } catch(e){}
    }

    /* Ensure each browser/tab has a stable user id so we can tell who created a booking. */
    function _getCurrentUserId(){
      try {
        let id = localStorage.getItem('booking_user_id');
        if (!id) { id = 'u_' + Date.now() + '_' + Math.floor(Math.random()*90000 + 10000); localStorage.setItem('booking_user_id', id); }
        return id;
      } catch(e) { return 'u_unknown'; }
    }

    /* --- Firestore integration (optional) -------------------------------------------------
       To enable shared, realtime bookings across users, call `setupFirestore(yourConfig)`
       with your Firebase project config object. Example:

       setupFirestore({
         apiKey: "...",
         authDomain: "...",
         projectId: "your-project-id",
         // ...other fields from Firebase console
       });

       The code below will load the compat SDK, initialize Firestore, start a listener
       to the `bookings` collection and provide a transaction-safe finalize path.
    ------------------------------------------------------------------------------------*/

    window._useFirestore = false; // flip to true by calling setupFirestore(config)
    window._firestoreReady = null;

    function setupFirestore(cfg){
      if (!cfg || !cfg.projectId) return console.warn('Firestore config missing. Call setupFirestore(config) with your Firebase config.');
      // load compat SDKs if not already present
      if (window._firestoreReady) return window._firestoreReady;
      window._firestoreReady = new Promise((resolve, reject) => {
        const base = 'https://www.gstatic.com/firebasejs/9.22.1/';
        const scripts = [base + 'firebase-app-compat.js', base + 'firebase-firestore-compat.js'];
        let loaded = 0;
        scripts.forEach(src => {
          const s = document.createElement('script'); s.src = src; s.onload = () => { loaded++; if (loaded === scripts.length) onAll(); };
          s.onerror = (e) => { console.error('Failed loading', src, e); reject(e); };
          document.head.appendChild(s);
        });
        function onAll(){
          try {
            firebase.initializeApp(cfg);
            window._firestore = firebase.firestore();
            window._useFirestore = true;
            startFirestoreListeners();
            resolve(true);
          } catch (e) { console.error('Firestore init error', e); reject(e); }
        }
      });
      return window._firestoreReady;
    }

    function startFirestoreListeners(){
      if (!window._useFirestore || !window._firestore) return;
      try {
        const col = window._firestore.collection('bookings');
        // Listen for any change and mirror to localStorage + refresh UI
        col.onSnapshot(snapshot => {
          const obj = {};
          const owners = {};
          snapshot.forEach(doc => {
            const data = doc.data() || {};
            const docId = doc.id;
            obj[docId] = Array.isArray(data.dates) ? data.dates.slice().sort() : [];
            // Also extract owner metadata if present
            owners[docId] = data.owners || {};
          });
          try { localStorage.setItem('room_bookings', JSON.stringify(obj)); } catch(e){}
          try { localStorage.setItem('room_booking_owners', JSON.stringify(owners)); } catch(e){}
          try { renderBookingCalendar(); } catch(e){}
        }, err => console.error('Bookings listener error', err));
      } catch (e){ console.warn('startFirestoreListeners failed', e); }
    }

    function finalizePendingBookingFirestore(pending){
      // pending: { category, dates: [...], ownerId, ownerName }
      if (!window._useFirestore || !window._firestore) return Promise.reject(new Error('Firestore not configured'));
      const cat = pending.category;
      const dates = (pending.dates||[]).slice();
      const ownerId = pending.ownerId;
      const ownerName = pending.ownerName;
      const ref = window._firestore.collection('bookings').doc(cat);
      
      return window._firestore.runTransaction(tx => {
        return tx.get(ref).then(doc => {
          const current = (doc.exists && Array.isArray(doc.data().dates)) ? doc.data().dates : [];
          const currentOwners = (doc.exists && doc.data().owners) ? doc.data().owners : {};
          
          const conflict = dates.find(d => current.indexOf(d) !== -1);
          if (conflict) throw new Error('conflict:' + conflict);
          
          const merged = Array.from(new Set((current || []).concat(dates))).sort();
          
          // Add owner metadata for these dates
          const mergedOwners = { ...currentOwners };
          dates.forEach(d => {
            mergedOwners[d] = { ownerId: ownerId, ownerName: ownerName };
          });
          
          tx.set(ref, { dates: merged, owners: mergedOwners }, { merge: true });
          return { dates: merged, owners: mergedOwners };
        });
      }).then(result => ({ok:true, dates: result.dates, owners: result.owners})).catch(err => ({ok:false, err: err && err.message ? err.message : String(err)}));
    }

    // Remove specific dates from a category document in Firestore
    function removeDatesFromFirestore(category, datesToRemove){
      if (!window._useFirestore || !window._firestore) return Promise.reject(new Error('Firestore not configured'));
      const ref = window._firestore.collection('bookings').doc(category);
      return window._firestore.runTransaction(tx => {
        return tx.get(ref).then(doc => {
          const current = (doc.exists && Array.isArray(doc.data().dates)) ? doc.data().dates : [];
          const currentOwners = (doc.exists && doc.data().owners) ? doc.data().owners : {};
          
          const remaining = current.filter(d => datesToRemove.indexOf(d) === -1);
          
          // Also remove owner metadata for deleted dates
          const remainingOwners = { ...currentOwners };
          datesToRemove.forEach(d => {
            delete remainingOwners[d];
          });
          
          tx.set(ref, { dates: remaining, owners: remainingOwners }, { merge: true });
          return { dates: remaining, owners: remainingOwners };
        });
      }).then(result => ({ok:true, dates: result.dates, owners: result.owners})).catch(err => ({ok:false, err: err && err.message ? err.message : String(err)}));
    }

    // Move (remove originals and add newDates) in a single Firestore transaction
    function moveDatesInFirestore(category, originals, newDates){
      if (!window._useFirestore || !window._firestore) return Promise.reject(new Error('Firestore not configured'));
      const ref = window._firestore.collection('bookings').doc(category);
      return window._firestore.runTransaction(tx => {
        return tx.get(ref).then(doc => {
          const current = (doc.exists && Array.isArray(doc.data().dates)) ? doc.data().dates : [];
          const currentOwners = (doc.exists && doc.data().owners) ? doc.data().owners : {};
          
          const existing = new Set(current);
          // remove originals temporarily for conflict check and owner transfer
          (originals||[]).forEach(d=> existing.delete(d));
          const conflict = (newDates||[]).find(d => existing.has(d));
          if (conflict) throw new Error('conflict:' + conflict);
          
          const merged = Array.from(new Set(Array.from(existing).concat(newDates))).sort();
          
          // Transfer owner metadata from original dates to new dates
          const mergedOwners = { ...currentOwners };
          for (let i = 0; i < (originals||[]).length; i++) {
            const orig = originals[i];
            const target = newDates[i] || newDates[0];
            if (orig && target && mergedOwners[orig]) {
              mergedOwners[target] = mergedOwners[orig];
              delete mergedOwners[orig];
            }
          }
          
          tx.set(ref, { dates: merged, owners: mergedOwners }, { merge: true });
          return { dates: merged, owners: mergedOwners };
        });
      }).then(result => ({ok:true, dates: result.dates, owners: result.owners})).catch(err => ({ok:false, err: err && err.message ? err.message : String(err)}));
    }


    let _bookingState = { category: null, year: null, month: null, selected: null };

    function openRoomBooking(category) {
      _bookingState.category = category;
      const modal = document.getElementById('bookingModal');
      const info = document.getElementById('bookingInfo');
      const title = category.split('-').pop();
      info.textContent = `Booking: ${title.replace(/^[a-z]/, s=>s.toUpperCase())}`;
      // initialize month/year to current
      const today = new Date();
      _bookingState.year = today.getFullYear();
      _bookingState.month = today.getMonth();
      _bookingState.selected = null;
      _bookingState.duration = 1;
      // set duration selector default
      const durEl = document.getElementById('bookingDuration');
      if (durEl) { durEl.value = '1'; durEl.onchange = function(){ _bookingState.duration = parseInt(this.value||'1',10); renderBookingCalendar(); }; }
      // populate surname input from last-used value
      try{ const sEl = document.getElementById('bookingSurname'); if (sEl) { sEl.value = localStorage.getItem('booking_user_name') || ''; } }catch(e){}
      renderBookingCalendar();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      // no pending booking check (finalize/manage flow removed)
      // bind prev/next
      document.getElementById('calPrev').onclick = () => { _bookingState.month--; if (_bookingState.month<0){_bookingState.month=11; _bookingState.year--;} renderBookingCalendar(); };
      document.getElementById('calNext').onclick = () => { _bookingState.month++; if (_bookingState.month>11){_bookingState.month=0; _bookingState.year++;} renderBookingCalendar(); };
      document.getElementById('confirmBook').onclick = confirmBooking;
    }

    function closeBooking() {
      const modal = document.getElementById('bookingModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    function renderBookingCalendar() {
      const cal = document.getElementById('bookingCalendar');
      const label = document.getElementById('calMonthLabel');
      const bookedList = document.getElementById('bookedList');
      cal.innerHTML = '';
      const year = _bookingState.year;
      const month = _bookingState.month;
      const date = new Date(year, month, 1);
      const monthName = date.toLocaleString(undefined, { month: 'long' });
      label.textContent = `${monthName} ${year}`;
      // week day headers
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      weekdays.forEach(d => { const h = document.createElement('div'); h.style.fontWeight='600'; h.style.fontSize='0.8rem'; h.textContent=d; cal.appendChild(h); });

      // days
      const firstDay = new Date(year, month, 1).getDay();
      for(let i=0;i<firstDay;i++){ const empty = document.createElement('div'); cal.appendChild(empty); }
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const bookings = _loadBookings();
      const catBookings = bookings[_bookingState.category] || [];
      const bookedSet = new Set(catBookings);
      const owners = _loadBookingOwners();
      const catOwners = owners[_bookingState.category] || {};
      const today = new Date();
      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div');
        cell.className = 'cal-day';
        const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isBooked = bookedSet.has(dayStr);
        // render date number element for consistent layout
        const num = document.createElement('div');
        num.className = 'date-number';
        num.textContent = d;
        cell.appendChild(num);
        cell.setAttribute('role','button');
        cell.setAttribute('tabindex','0');
        cell.setAttribute('aria-label', dayStr + (isBooked ? ' booked' : ' available'));
        if (isBooked) { cell.setAttribute('aria-disabled','true'); }
        if (isBooked) {
          cell.classList.add('booked');
          // attach owner tooltip/title when available
          const o = catOwners[dayStr];
          if (o && o.ownerName) {
            cell.title = `Reserved for the ${o.ownerName} family`;
          } else {
            cell.title = 'Reserved';
          }
          // meatball menu button (three-dot) that opens a small popup with actions
          // ONLY show button if current user is the owner
          const cur = _getCurrentUserId();
          const owner = (catOwners && catOwners[dayStr]) ? catOwners[dayStr].ownerId : null;
          const isOwner = (owner === null || owner === cur);
          
          cell.style.position = cell.style.position || 'relative';
          const mb = document.createElement('button');
          mb.className = 'meatball-btn';
          mb.type = 'button';
          mb.setAttribute('aria-haspopup','true');
          mb.setAttribute('aria-expanded','false');
          mb.title = isOwner ? 'Options' : 'Reserved by another user';
          mb.textContent = 'â‹®';
          mb.style.position = 'absolute';
          mb.style.top = '6px';
          mb.style.right = '6px';
          mb.style.background = 'transparent';
          mb.style.border = 'none';
          mb.style.color = isBooked ? '#fff' : '#2f4963';
          mb.style.fontSize = '1rem';
          mb.style.cursor = isOwner ? 'pointer' : 'not-allowed';
          mb.style.padding = '2px 4px';
          mb.style.opacity = isOwner ? '1' : '0.4';
          mb.disabled = !isOwner;

          const menu = document.createElement('div');
          menu.className = 'cell-menu';
          menu.style.display = 'none';
          menu.style.position = 'absolute';
          menu.style.top = '30px';
          menu.style.right = '6px';
          menu.style.flexDirection = 'column';
          menu.style.background = '#fff';
          menu.style.border = '1px solid #ccc';
          menu.style.borderRadius = '6px';
          menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
          menu.style.zIndex = '2000';
          menu.style.minWidth = '120px';
          menu.style.overflow = 'hidden';

          const optDel = document.createElement('button');
          optDel.type = 'button';
          optDel.textContent = 'Remove date';
          optDel.style.padding = '8px';
          optDel.style.textAlign = 'left';
          optDel.style.background = 'transparent';
          optDel.style.border = 'none';
          optDel.style.cursor = 'pointer';
          optDel.onclick = (ev)=>{ ev.stopPropagation();
            if (confirm('Delete booking '+dayStr+'?')){ deleteBookedDate(dayStr); }
            menu.style.display='none'; mb.setAttribute('aria-expanded','false');
          };

          const optMove = document.createElement('button');
          optMove.type = 'button';
          optMove.textContent = 'Move date';
          optMove.style.padding = '8px';
          optMove.style.textAlign = 'left';
          optMove.style.background = 'transparent';
          optMove.style.border = 'none';
          optMove.style.cursor = 'pointer';
          optMove.onclick = (ev)=>{ ev.stopPropagation();
            startMoveBooking(dayStr); menu.style.display='none'; mb.setAttribute('aria-expanded','false'); };

          menu.appendChild(optDel);
          menu.appendChild(optMove);

          mb.onclick = (e)=>{ e.stopPropagation(); if (!isOwner) { alert('Only the user who reserved this date can manage it.'); return; } const open = mb.getAttribute('aria-expanded')==='true'; closeAllCellMenus(); if (!open) { menu.style.display='flex'; mb.setAttribute('aria-expanded','true'); } else { menu.style.display='none'; mb.setAttribute('aria-expanded','false'); } };

          cell.appendChild(mb);
          cell.appendChild(menu);
        }
        // mark today
        if (year===today.getFullYear() && month===today.getMonth() && d===today.getDate()) { cell.classList.add('today'); }
        // keyboard accessibility: allow Enter/Space to select or complete move
        cell.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); cell.click(); } };
        // selection & range preview for unbooked dates
        if (!isBooked){
          cell.onclick = () => {
            // if in move-mode, attempt to move original booking(s) to this start
            if (_moveState && _moveState.category === _bookingState.category) {
              const newStart = new Date(year, month, d);
              const newDates = [];
              for(let i=0;i<_moveState.length;i++){
                const dt = new Date(newStart.getFullYear(), newStart.getMonth(), newStart.getDate()+i);
                const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
                newDates.push(key);
              }
              const cat = _moveState.category;
              // If Firestore is configured, perform the move in Firestore
              if (window._useFirestore && window._firestoreReady) {
                window._firestoreReady.then(()=> moveDatesInFirestore(cat, _moveState.original || [], newDates)).then(res=>{
                  if (!res || !res.ok){
                    const msg = res && res.err ? res.err : 'Unknown error';
                    if (typeof msg === 'string' && msg.indexOf('conflict:')===0){
                      const conflict = msg.split(':')[1] || msg;
                      return alert('Cannot move: target dates conflict with existing booking: '+conflict);
                    }
                    return alert('Error moving booking: ' + msg);
                  }
                  try { const bookings = _loadBookings(); bookings[cat] = res.dates || []; _saveBookings(bookings); } catch(e){}
                  // try transfer owner metadata locally (best-effort)
                  try{
                    const owners = _loadBookingOwners();
                    owners[cat] = owners[cat] || {};
                    const originals = (_moveState.original||[]).slice();
                    for(let i=0;i<originals.length;i++){
                      const orig = originals[i];
                      const ownerObj = owners[cat] && owners[cat][orig] ? owners[cat][orig] : null;
                      if (ownerObj) {
                        const target = newDates[i] || newDates[0];
                        if (target) { owners[cat][target] = ownerObj; delete owners[cat][orig]; }
                      }
                    }
                    _saveBookingOwners(owners);
                  } catch(e){}
                  _moveState = null;
                  alert('Booking moved to: ' + newDates.join(', '));
                  renderBookingCalendar();
                }).catch(err=>{ console.error('Firestore move error', err); alert('Unable to move booking via Firestore.'); });
                return;
              }
              // Fallback: localStorage move
              const bookings = _loadBookings();
              const existing = new Set(bookings[cat] || []);
              (_moveState.original || []).forEach(d=> existing.delete(d));
              const conflict = newDates.find(d=> existing.has(d));
              if (conflict) return alert('Cannot move: target dates conflict with existing booking: '+conflict);
              bookings[cat] = (bookings[cat] || []).filter(d=> !((_moveState.original||[]).includes(d))).concat(newDates);
              bookings[cat] = Array.from(new Set(bookings[cat])).sort();
              _saveBookings(bookings);
              // Transfer owner metadata for moved dates (local-only)
              try{
                const owners = _loadBookingOwners();
                owners[cat] = owners[cat] || {};
                const originals = (_moveState.original||[]).slice();
                for(let i=0;i<originals.length;i++){
                  const orig = originals[i];
                  const ownerObj = owners[cat] && owners[cat][orig] ? owners[cat][orig] : null;
                  if (ownerObj) {
                    // assign to corresponding new date if available, else skip
                    const target = newDates[i] || newDates[0];
                    if (target) { owners[cat][target] = ownerObj; delete owners[cat][orig]; }
                  }
                }
                _saveBookingOwners(owners);
              } catch(e){}
              _moveState = null;
              alert('Booking moved to: ' + newDates.join(', '));
              renderBookingCalendar();
              return;
            }
            // regular selection: set selected start
            _bookingState.selected = dayStr;
            // update visual: clear outlines and range
            Array.from(cal.querySelectorAll('.cal-day')).forEach(n=>{ n.style.outline=''; n.classList.remove('selected-range'); });
            cell.style.outline = '2px solid #2f4963';
            // apply selected-range for duration days
            const dur = _bookingState.duration || 1;
            for(let offset=0; offset<dur; offset++){
              const dt = new Date(year, month, d+offset);
              if (dt.getMonth()!==month) break; // don't overflow month
              const dayKey = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
              const node = Array.from(cal.querySelectorAll('.cal-day')).find(n=>n.textContent==String(dt.getDate()));
              if (node && !node.classList.contains('booked')) node.classList.add('selected-range');
            }
          };
        }
        cal.appendChild(cell);
      }
      // show booked dates list
      if (catBookings.length) {
        try {
          const parts = catBookings.map(d => {
            const o = (catOwners && catOwners[d]) ? catOwners[d].ownerName : null;
            return o ? `${d} (${o} family)` : d;
          });
          bookedList.textContent = `Booked dates: ${parts.join(', ')}`;
        } catch(e){ bookedList.textContent = `Booked dates: ${catBookings.join(', ')}`; }
      } else {
        bookedList.textContent = 'No bookings for this category yet.';
      }
    }

    // move state for editing bookings
    let _moveState = null;

    // helper: close any open cell menus
    function closeAllCellMenus(){
      Array.from(document.querySelectorAll('.cell-menu')).forEach(m=>{ m.style.display='none'; });
      Array.from(document.querySelectorAll('.meatball-btn')).forEach(b=>{ try{ b.setAttribute('aria-expanded','false'); }catch(e){} });
    }

    // ensure clicks outside menus close them (init once)
    if (!window._cellMenuInit) {
      window._cellMenuInit = true;
      document.addEventListener('click', function(e){ if (!e.target.closest || !(e.target.closest('.cell-menu') || e.target.closest('.meatball-btn'))) { closeAllCellMenus(); } });
    }

    // Show a small popup asking the user to confirm they've submitted the form,
    // then show a thank-you message when they confirm.
    function showFormSubmittedNotice(){
      // remove existing if present
      const existing = document.getElementById('formSubmitPopup');
      if (existing) existing.remove();
      const wrap = document.createElement('div');
      wrap.id = 'formSubmitPopup';
      wrap.className = 'form-submit-popup';

      // Build a warm, welcoming layout
      wrap.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;">
          <div style="width:84px;height:84px;border-radius:24px;background:linear-gradient(135deg,#fff7ec,#fff1e0);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(245,170,80,0.12);">
            <div style="font-size:38px;color:#f2953b;">â­</div>
          </div>
          <h3 style="margin:0;font-size:1.45rem;color:#14363f;">Thanks â€” one more step</h3>
          <div class="info">We opened a short form in a new tab to collect a few details. After you submit, click the button below to finish.</div>
        </div>
        <div style="flex:1; width:100%;"></div>
        <div class="form-submit-actions" style="justify-content:center;">
          <button class="primary" id="confirmSubmitted">I submitted the form</button>
          <button class="secondary" id="closeSubmit">Not yet</button>
        </div>
      `;

      document.body.appendChild(wrap);

      // attach handlers
      const c = document.getElementById('confirmSubmitted');
      const cl = document.getElementById('closeSubmit');
      if (c) c.onclick = () => { finalizePendingBooking(); };
      if (cl) cl.onclick = () => { wrap.remove(); };
    }

    function showThankYou(){
      const wrap = document.getElementById('formSubmitPopup');
      if (wrap) {
        wrap.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;">
            <div style="width:96px;height:96px;border-radius:22px;background:linear-gradient(135deg,#e6fff6,#dffaf0);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(38,160,128,0.08);">
              <div style="font-size:44px;color:#1fa675;">âœ“</div>
            </div>
            <h2 style="margin:0;font-size:1.6rem;color:#0f3b36;">Thank you for booking!</h2>
            <div class="info">We've received your booking and the details you submitted. We'll reach out shortly to confirm arrangements.</div>
          </div>
          <div style="flex:1;"></div>
          <div style="width:100%;display:flex;justify-content:center;margin-top:6px;">
            <button class="primary" id="closeThank">Close</button>
          </div>
        `;
        const cb = document.getElementById('closeThank'); if (cb) cb.onclick = ()=>{ wrap.remove(); };
      } else {
        alert('Thank you for booking!');
      }
    }

    // Finalize a previously-pending booking (called after user confirms they submitted the form)
    function finalizePendingBooking(){
          let pending = null;
          try { pending = JSON.parse(localStorage.getItem('pending_room_booking') || 'null'); } catch(e){ pending = null; }
          if (!pending) return alert('No pending booking found. Please start the booking process again.');

          // If Firestore is configured, attempt a transaction-safe finalize there first
          if (window._useFirestore && window._firestoreReady) {
            window._firestoreReady.then(()=> finalizePendingBookingFirestore(pending)).then(res => {
              if (!res || !res.ok) {
                const msg = res && res.err ? res.err : 'Unknown error';
                if (typeof msg === 'string' && msg.indexOf('conflict:')===0){
                  const conflict = msg.split(':')[1] || msg;
                  return alert('Unable to finalize: one or more dates were already taken: ' + conflict);
                }
                return alert('Error finalizing booking: ' + msg);
              }
              // success: mirror result to local storage and UI
              try { const bookings = _loadBookings(); bookings[pending.category] = res.dates || []; _saveBookings(bookings); } catch(e){}
                  try {
                    // store owner metadata locally for these dates
                    try {
                      const owners = _loadBookingOwners();
                      const cat = pending.category;
                      owners[cat] = owners[cat] || {};
                      (pending.dates || []).forEach(d => { owners[cat][d] = { ownerId: pending.ownerId || _getCurrentUserId(), ownerName: pending.ownerName || localStorage.getItem('booking_user_name') || null }; });
                      _saveBookingOwners(owners);
                    } catch(e){}
                  } catch(e){}
                  try { localStorage.removeItem('pending_room_booking'); } catch(e){}
              removePendingBanner(); alert('Booking finalized. Dates booked: ' + (res.dates||[]).join(', ')); renderBookingCalendar(); showThankYou();
            }).catch(err=>{ console.error('Firestore finalize error', err); alert('Unable to finalize booking via Firestore.'); });
            return;
          }

          // Fallback: localStorage-only finalize (single-browser scope)
          const bookings = _loadBookings();
          const cat = pending.category;
          bookings[cat] = bookings[cat] || [];
          // ensure no conflicts (someone may have booked meanwhile)
          const existing = new Set(bookings[cat]);
          const conflict = (pending.dates || []).find(d => existing.has(d));
          if (conflict) return alert('Unable to finalize: one or more dates were already taken: ' + conflict);
          bookings[cat] = Array.from(new Set(bookings[cat].concat(pending.dates))).sort();
          _saveBookings(bookings);
          // Save owner metadata for these dates (local-only)
          try {
            const owners = _loadBookingOwners();
            owners[cat] = owners[cat] || {};
            (pending.dates || []).forEach(d => { owners[cat][d] = { ownerId: pending.ownerId || _getCurrentUserId(), ownerName: pending.ownerName || localStorage.getItem('booking_user_name') || null }; });
            _saveBookingOwners(owners);
          } catch(e){}
          // clear pending
          try { localStorage.removeItem('pending_room_booking'); } catch(e){}
          removePendingBanner();
          alert('Booking finalized. Dates booked: ' + bookings[cat].join(', '));
          renderBookingCalendar();
          // show friendly thank-you UI
          showThankYou();
    }

    // Render a small persistent banner if a pending booking exists
    function renderPendingBanner(){
      // remove any existing
      const exist = document.getElementById('pendingBanner');
      if (exist) exist.remove();
      let pending = null;
      try { pending = JSON.parse(localStorage.getItem('pending_room_booking') || 'null'); } catch(e){ pending = null; }
      if (!pending) return;
      const wrap = document.createElement('div');
      wrap.id = 'pendingBanner';
      wrap.className = 'pending-banner';
      const info = document.createElement('div'); info.className = 'pb-info';
      info.textContent = `Pending booking: ${pending.category.replace(/-/g,' ')} â€” ${ (pending.dates||[]).slice(0,3).join(', ')}${(pending.dates && pending.dates.length>3)?'...':''}`;
      const actions = document.createElement('div'); actions.className = 'pb-actions';
      const fin = document.createElement('button'); fin.className='primary'; fin.textContent='Finalize'; fin.onclick = ()=>{ finalizePendingBooking(); };
      const canc = document.createElement('button'); canc.className='cancel'; canc.textContent='Cancel'; canc.onclick = ()=>{ cancelPendingBooking(); };
      actions.appendChild(fin); actions.appendChild(canc);
      wrap.appendChild(info); wrap.appendChild(actions);
      document.body.appendChild(wrap);
    }

    function removePendingBanner(){ const b = document.getElementById('pendingBanner'); if (b) b.remove(); }

    function cancelPendingBooking(){ if (!confirm('Cancel the pending booking?')) return; try{ localStorage.removeItem('pending_room_booking'); }catch(e){} removePendingBanner(); alert('Pending booking cancelled.'); }

    // --- Inbox (slide-out) UI for pending bookings ---
    function ensurePendingButton(){
      // Floating pending button removed â€” banner and inbox panel remain accessible via other controls.
      return;
    }

    function updateInboxBadge(){
      // cleanup expired before counting
      cleanPendingBookings();
      const b1 = document.getElementById('inboxBadge');
      const b2 = document.getElementById('pendingBadge');
      let count = 0;
      try {
        if (localStorage.getItem('pending_room_booking')) count++;
        const arr = JSON.parse(localStorage.getItem('pending_room_bookings')||'[]');
        if (Array.isArray(arr)) count += arr.length;
      } catch(e){}
      // update badges (banner / inbox markers)
      if (b1){ if (count>0){ b1.style.display='inline-block'; b1.textContent = String(count);} else { b1.style.display='none'; } }
      if (b2){ if (count>0){ b2.style.display='inline-block'; b2.textContent = String(count);} else { b2.style.display='none'; } }
    }

    function toggleInboxPanel(){ const panel = document.getElementById('inboxPanel'); if (panel) { panel.remove(); return; } renderInboxPanel(); }

    function renderInboxPanel(){
      // remove existing
      const existing = document.getElementById('inboxPanel'); if (existing) existing.remove();
      // cleanup expired pendings before showing
      cleanPendingBookings();
      const panel = document.createElement('div'); panel.id = 'inboxPanel'; panel.className = 'inbox-panel';
      const hdr = document.createElement('div'); hdr.style.display='flex'; hdr.style.justifyContent='space-between'; hdr.style.alignItems='center';
      const h3 = document.createElement('h3'); h3.textContent = 'Pending Bookings'; hdr.appendChild(h3);
      const close = document.createElement('button'); close.textContent='âœ•'; close.style.border='none'; close.style.background='transparent'; close.style.cursor='pointer'; close.onclick = ()=>panel.remove(); hdr.appendChild(close);
      panel.appendChild(hdr);
      const list = document.createElement('div'); list.className = 'inbox-list';

      // gather pending items: single + array
      const items = [];
      try {
        const single = JSON.parse(localStorage.getItem('pending_room_booking') || 'null');
        if (single) items.push(single);
      } catch(e){}
      try {
        const arr = JSON.parse(localStorage.getItem('pending_room_bookings') || '[]'); if (Array.isArray(arr)) arr.forEach(a=>items.push(a));
      } catch(e){}

      if (!items.length){ const em = document.createElement('div'); em.style.color='#49686a'; em.textContent='No pending bookings.'; list.appendChild(em); }

      items.forEach(it=>{
        const node = document.createElement('div'); node.className='inbox-item';
        const title = document.createElement('div'); title.className='meta'; title.textContent = (it.category||'room').replace(/-/g,' ');
        const dates = document.createElement('div'); dates.className='dates'; dates.textContent = (it.dates||[]).join(', ');
        node.appendChild(title); node.appendChild(dates);
        const actions = document.createElement('div'); actions.className='inbox-actions';
        const fin = document.createElement('button'); fin.className='primary'; fin.textContent='Finalize'; fin.onclick = ()=>{ finalizePendingObject(it); };
        const del = document.createElement('button'); del.className='cancel'; del.textContent='Cancel'; del.onclick = ()=>{ cancelPendingObject(it); };
        actions.appendChild(del); actions.appendChild(fin);
        node.appendChild(actions);
        list.appendChild(node);
      });

      panel.appendChild(list);
      document.body.appendChild(panel);
      // update badge after rendering
      updateInboxBadge();
    }

    // finalize a pending object (used by inbox). It mirrors finalizePendingBooking but accepts the object.
    function finalizePendingObject(pending){
          if (!pending) return alert('No pending item selected.');
          // If Firestore is configured, attempt transactional finalize there first
          if (window._useFirestore && window._firestoreReady) {
            window._firestoreReady.then(()=> finalizePendingBookingFirestore(pending)).then(res=>{
              if (!res || !res.ok){
                const msg = res && res.err ? res.err : 'Unknown error';
                if (typeof msg === 'string' && msg.indexOf('conflict:')===0){
                  const conflict = msg.split(':')[1] || msg;
                  return alert('Unable to finalize: one or more dates were already taken: ' + conflict);
                }
                return alert('Error finalizing booking: ' + msg);
              }
              try { const bookings = _loadBookings(); bookings[pending.category] = res.dates || []; _saveBookings(bookings); } catch(e){}
              // remove pending from storage (handle single and array)
              try { const single = JSON.parse(localStorage.getItem('pending_room_booking')||'null'); if (single && single.timestamp && pending.timestamp && single.timestamp === pending.timestamp) { localStorage.removeItem('pending_room_booking'); } } catch(e){}
              try { const arr = JSON.parse(localStorage.getItem('pending_room_bookings')||'[]'); if (Array.isArray(arr) && arr.length){ const filtered = arr.filter(a=> !(a && a.timestamp && pending.timestamp && a.timestamp===pending.timestamp)); localStorage.setItem('pending_room_bookings', JSON.stringify(filtered)); } } catch(e){}
              removePendingBanner(); updateInboxBadge(); renderBookingCalendar(); showThankYou(); const p = document.getElementById('inboxPanel'); if (p) p.remove();
            }).catch(err=>{ console.error('Firestore finalize error', err); alert('Unable to finalize booking via Firestore.'); });
            return;
          }
          // Fallback: localStorage-only finalize
          const bookings = _loadBookings();
          const cat = pending.category;
          bookings[cat] = bookings[cat] || [];
          const existing = new Set(bookings[cat]);
          const conflict = (pending.dates||[]).find(d=> existing.has(d));
          if (conflict) return alert('Unable to finalize: one or more dates were already taken: ' + conflict);
          bookings[cat] = Array.from(new Set(bookings[cat].concat(pending.dates))).sort();
          _saveBookings(bookings);
          // remove pending from storage (handle single and array)
          try {
            const single = JSON.parse(localStorage.getItem('pending_room_booking')||'null');
            if (single && single.timestamp && pending.timestamp && single.timestamp === pending.timestamp) { localStorage.removeItem('pending_room_booking'); }
          } catch(e){}
          try {
            const arr = JSON.parse(localStorage.getItem('pending_room_bookings')||'[]');
            if (Array.isArray(arr) && arr.length){
              const filtered = arr.filter(a=> !(a && a.timestamp && pending.timestamp && a.timestamp===pending.timestamp));
              localStorage.setItem('pending_room_bookings', JSON.stringify(filtered));
            }
          } catch(e){}
          removePendingBanner(); updateInboxBadge(); renderBookingCalendar(); showThankYou(); const p = document.getElementById('inboxPanel'); if (p) p.remove();
    }

    function cancelPendingObject(pending){ if (!pending) return; if (!confirm('Cancel this pending booking?')) return; try{
      const single = JSON.parse(localStorage.getItem('pending_room_booking')||'null'); if (single && single.timestamp && pending.timestamp && single.timestamp===pending.timestamp){ localStorage.removeItem('pending_room_booking'); }
      const arr = JSON.parse(localStorage.getItem('pending_room_bookings')||'[]'); if (Array.isArray(arr) && arr.length){ const filtered = arr.filter(a=> !(a && a.timestamp && pending.timestamp && a.timestamp===pending.timestamp)); localStorage.setItem('pending_room_bookings', JSON.stringify(filtered)); }
    }catch(e){}
    removePendingBanner(); updateInboxBadge(); const p = document.getElementById('inboxPanel'); if (p) p.remove(); alert('Pending booking cancelled.'); }

    // Remove expired pending bookings older than `expireMs` (defaults to 24 hours)
    function cleanPendingBookings(expireMs){
      const ms = typeof expireMs === 'number' ? expireMs : (24*60*60*1000);
      const now = Date.now();
      // single pending
      try {
        const single = JSON.parse(localStorage.getItem('pending_room_booking') || 'null');
        if (single && single.timestamp && (now - single.timestamp) > ms) {
          try { localStorage.removeItem('pending_room_booking'); }catch(e){}
        }
      } catch(e){}
      // array pendings
      try {
        const arr = JSON.parse(localStorage.getItem('pending_room_bookings') || '[]');
        if (Array.isArray(arr) && arr.length){
          const kept = arr.filter(a=> !(a && a.timestamp && ((now - a.timestamp) > ms)) );
          if (kept.length !== arr.length){
            try { localStorage.setItem('pending_room_bookings', JSON.stringify(kept)); } catch(e){}
          }
        }
      } catch(e){}
    }

    function confirmBooking() {
      if (!_bookingState.category) return alert('No category selected.');
      if (!_bookingState.selected) return alert('Please select a start date to book.');
      const bookings = _loadBookings();
      bookings[_bookingState.category] = bookings[_bookingState.category] || [];
      const dur = parseInt((document.getElementById('bookingDuration')||{value:'1'}).value||'1',10);
      if (dur > 7) return alert('Max booking length is 7 days.');
      // build date list
      const start = new Date(_bookingState.selected);
      const datesToBook = [];
      for(let i=0;i<dur;i++){
        const dt = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
        const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        datesToBook.push(key);
      }
      // check conflicts for this category
      const existing = new Set(bookings[_bookingState.category] || []);
      const conflict = datesToBook.find(d=> existing.has(d));
      if (conflict) { alert('One or more selected dates are already booked for this room: ' + conflict); renderBookingCalendar(); return; }

      // Read surname input to attach to this reservation (shown on hover)
      const surnameEl = document.getElementById('bookingSurname');
      const enteredName = surnameEl ? String(surnameEl.value||'').trim() : (localStorage.getItem('booking_user_name')||'');
      if (!enteredName) { alert('Surname/family name required to reserve the date. Booking cancelled.'); renderBookingCalendar(); return; }
      try { localStorage.setItem('booking_user_name', enteredName); } catch(e){}
      const ownerId = _getCurrentUserId();
      // Store as a pending booking (includes owner metadata)
      const pending = { category: _bookingState.category, dates: datesToBook, timestamp: Date.now(), ownerId: ownerId, ownerName: enteredName };
      try { localStorage.setItem('pending_room_booking', JSON.stringify(pending)); } catch(e){}
      
      // Pre-populate owner metadata so it's immediately available (not just after finalize)
      try {
        const owners = _loadBookingOwners();
        owners[_bookingState.category] = owners[_bookingState.category] || {};
        datesToBook.forEach(d => {
          owners[_bookingState.category][d] = { ownerId: ownerId, ownerName: enteredName };
        });
        _saveBookingOwners(owners);
        try { console.log('Booking: saved owner metadata', { category: _bookingState.category, dates: datesToBook, ownerId: ownerId, ownerName: enteredName }); } catch(e){}
      } catch(e){}
      
      // Also immediately add dates to bookings so they show as reserved
      try {
        const bookings = _loadBookings();
        bookings[_bookingState.category] = bookings[_bookingState.category] || [];
        datesToBook.forEach(d => {
          if (!bookings[_bookingState.category].includes(d)) {
            bookings[_bookingState.category].push(d);
          }
        });
        bookings[_bookingState.category] = Array.from(new Set(bookings[_bookingState.category])).sort();
        _saveBookings(bookings);
        try { console.log('Booking: saved bookings', bookings[_bookingState.category]); } catch(e){}
      } catch(e){}

      // Open external Google Form in new tab for additional info (per-category URLs)
      let formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSd5olAdmp_RxgQESYuIgw6LlA-r9Xa8NmNiXxON4fkALEb0WA/viewform';
      const cat = (_bookingState.category || '').toLowerCase();
      if (cat.includes('premium')) {
        formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScWAM3e0Dzp97i1rL27kW8se2eZbPFT-BAoeiTgtZjBQ31mgA/viewform';
      } else if (cat.includes('deluxe')) {
        formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSeekkT9qXGygD4Rg4tvcdzAKLXfGjAIs0k1PlAw6Na3IBboig/viewform';
      }
      try { window.open(formUrl, '_blank'); } catch(e){}

      // close modal (do not mark dates as booked yet)
      closeBooking();

      // show popup asking user to confirm they submitted the form; only then finalize
      setTimeout(()=>{ try{ showFormSubmittedNotice(); }catch(e){} }, 250);
    }

    /* Pending/finalize flow removed: confirmBooking saves immediately. */

    /* Manage UI removed per user request. Booking list now shows booked dates in the calendar view. */

    function deleteBookedDate(dateStr){
      const cat = _bookingState.category;
      const cur = _getCurrentUserId();
      
      try { console.log('Attempting delete', { category: cat, date: dateStr, currentUser: cur }); } catch(e){}
      try { console.log('Known owners:', _loadBookingOwners()[cat] || {}); } catch(e){}

      // STRICT GUARD: Check owner before ANY deletion (checks Firestore first if available)
      const owners = _loadBookingOwners();
      const ownerData = owners && owners[cat] && owners[cat][dateStr] ? owners[cat][dateStr] : null;
      const ownerId = ownerData ? ownerData.ownerId : null;
      const ownerName = ownerData ? ownerData.ownerName : null;
      
      // CRITICAL: If there is owner data and current user is NOT the owner, BLOCK immediately
      if (ownerData && ownerId) {
        // Owner data exists â€” only allow deletion if current user is the owner
        if (ownerId !== cur) {
          alert(`This date is reserved for the ${ownerName} family.\n\nOnly they can remove this booking. You do not have permission.`);
          return false;
        }
      } else {
        // No owner data found â€” this might be a booking from before owner tracking was added
        // For safety, block deletion unless user confirms they own it
        const confirmDelete = confirm(`No owner information found for this date.\n\nIf you booked this date, click OK to delete it.\n\nOtherwise, click Cancel.`);
        if (!confirmDelete) return false;
      }
      
      // If Firestore is enabled, double-check owner on the server before deleting
      if (window._useFirestore && window._firestoreReady && window._firestore) {
        return window._firestoreReady.then(()=>{
          const ref = window._firestore.collection('bookings').doc(cat);
          return ref.get().then(doc => {
            const data = doc.exists ? doc.data() || {} : {};
            const remoteOwners = data.owners || {};
            const remoteOwner = remoteOwners && remoteOwners[dateStr] ? remoteOwners[dateStr].ownerId : null;
            const remoteOwnerName = remoteOwners && remoteOwners[dateStr] ? remoteOwners[dateStr].ownerName : null;
            if (remoteOwner && remoteOwner !== cur) {
              alert('This date is reserved for the ' + (remoteOwnerName||'another') + ' family. Only they can remove it. You do not have permission.');
              return;
            }
            // proceed with deletion via Firestore transaction helper
            return removeDatesFromFirestore(cat, [dateStr]).then(res => {
              if (!res || !res.ok){ alert('Unable to remove booking: '+(res && res.err?res.err:'unknown error')); return; }
              try { const bookings = _loadBookings(); bookings[cat] = res.dates || []; _saveBookings(bookings); }catch(e){}
              // also remove local owner metadata for that date
              try{ const owners = _loadBookingOwners(); if (owners && owners[cat]) { delete owners[cat][dateStr]; _saveBookingOwners(owners); } }catch(e){}
              alert('Deleted booking '+dateStr);
              renderBookingCalendar();
            }).catch(err=>{ console.error('Firestore delete error', err); alert('Error deleting booking.'); });
          }).catch(err=>{ console.error('Failed reading booking doc', err); alert('Unable to verify server ownership. Delete aborted.'); });
        });
      }
      // Fallback: localStorage
      const bookings = _loadBookings();
      bookings[cat] = (bookings[cat] || []).filter(d=>d!==dateStr);
      _saveBookings(bookings);
      // remove owner metadata for this date
      try{ const owners = _loadBookingOwners(); if (owners && owners[cat]) { delete owners[cat][dateStr]; _saveBookingOwners(owners); } }catch(e){}
      alert('Deleted booking '+dateStr);
      renderBookingCalendar();
    }

    function startMoveBooking(dateStr){
      // STRICT GUARD: Check owner before ANY move attempt â€” if Firestore enabled, verify server-side first
      const cur = _getCurrentUserId();
      const owners = _loadBookingOwners();
      const ownerData = owners && owners[_bookingState.category] && owners[_bookingState.category][dateStr] ? owners[_bookingState.category][dateStr] : null;
      const ownerId = ownerData ? ownerData.ownerId : null;
      const ownerName = ownerData ? ownerData.ownerName : null;

      if (window._useFirestore && window._firestoreReady && window._firestore) {
        return window._firestoreReady.then(()=>{
          const ref = window._firestore.collection('bookings').doc(_bookingState.category);
          return ref.get().then(doc => {
            const data = doc.exists ? doc.data() || {} : {};
            const remoteOwners = data.owners || {};
            const remoteOwner = remoteOwners && remoteOwners[dateStr] ? remoteOwners[dateStr].ownerId : null;
            const remoteOwnerName = remoteOwners && remoteOwners[dateStr] ? remoteOwners[dateStr].ownerName : null;
            if (remoteOwner && remoteOwner !== cur) {
              alert('This date is reserved for the ' + (remoteOwnerName||'another') + ' family. Only they can move it. You do not have permission.');
              return;
            }
            // allowed â€” start move
            _moveState = { category: _bookingState.category, original: [dateStr], length: 1 };
            const bookedList = document.getElementById('bookedList');
            bookedList.innerHTML = '';
            const info = document.createElement('div'); info.style.color='#2f4963'; info.textContent = 'Move mode: pick a new start date on the calendar.';
            bookedList.appendChild(info);
          }).catch(err=>{ console.error('Failed reading booking doc', err); alert('Unable to verify server ownership. Move aborted.'); });
        });
      }

      // Local-only path (no Firestore) â€” enforce via local owner metadata
      if (ownerData && ownerId) {
        if (ownerId !== cur) {
          alert('This date is reserved for the ' + (ownerName||'another') + ' family. Only they can move it. You do not have permission.');
          return false;
        }
      } else {
        const confirmMove = confirm('No owner information found for this date. If you booked this date, click OK to move it. Otherwise, click Cancel.');
        if (!confirmMove) return false;
      }

      _moveState = { category: _bookingState.category, original: [dateStr], length: 1 };
      const bookedList = document.getElementById('bookedList');
      bookedList.innerHTML = '';
      const info = document.createElement('div'); info.style.color='#2f4963'; info.textContent = 'Move mode: pick a new start date on the calendar.';
      bookedList.appendChild(info);
    }

    // --- Admin: hidden button + privileged delete-all handler --------------------
    // Adds a hidden button that an admin can reveal; clicking it will remove
    // all bookings and owner metadata. Works with Firestore (if enabled) or
    // falls back to localStorage-only removal.
    function adminDeleteAllBookings(){
      if (!confirm('Admin: delete ALL bookings from all categories? This cannot be undone.')) return;

      // If Firestore is configured, attempt server-side wipe first
      if (window._useFirestore && window._firestoreReady && window._firestore) {
        return window._firestoreReady.then(()=>{
          try {
            const col = window._firestore.collection('bookings');
            return col.get().then(querySnapshot => {
              const ops = [];
              querySnapshot.forEach(doc => {
                try {
                  // clear dates and owners for each category document
                  ops.push(doc.ref.set({ dates: [], owners: {} }, { merge: true }));
                } catch(e) { /* continue */ }
              });
              return Promise.all(ops);
            }).then(()=>{
              try { _saveBookings({}); _saveBookingOwners({}); } catch(e){}
              alert('All bookings deleted (server + local).');
              try { renderBookingCalendar(); } catch(e){}
            }).catch(err=>{ console.error('Admin delete all (server) error', err); alert('Error deleting bookings on server: ' + (err && err.message?err.message:String(err))); });
          } catch(e){ console.error('Admin delete-all unexpected', e); alert('Error performing admin delete.'); }
        }).catch(err=>{ console.error('Firestore ready failed', err); alert('Unable to reach server to delete bookings.'); });
      }

      // Local-only fallback: clear local stored bookings & owners
      try {
        _saveBookings({});
        _saveBookingOwners({});
        alert('All bookings deleted (local only).');
        try { renderBookingCalendar(); } catch(e){}
      } catch(e){ console.error('Admin delete all (local) error', e); alert('Error deleting local bookings'); }
    }

    // Create a hidden admin button appended to the page. It's hidden by default.
    (function createAdminButton(){
      try {
        const existing = document.getElementById('adminDeleteAllBtn');
        if (existing) return;
        const btn = document.createElement('button');
        btn.id = 'adminDeleteAllBtn';
        btn.type = 'button';
        btn.textContent = 'Admin: Delete All Bookings';
        btn.style.display = 'none';
        btn.style.position = 'fixed';
        btn.style.bottom = '12px';
        btn.style.right = '12px';
        btn.style.zIndex = '3500';
        btn.style.background = '#b71c1c';
        btn.style.color = '#fff';
        btn.style.border = 'none';
        btn.style.padding = '10px 12px';
        btn.style.borderRadius = '6px';
        btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.16)';
        btn.style.cursor = 'pointer';
        btn.onclick = function(e){ e.preventDefault(); adminDeleteAllBookings(); };
        document.body.appendChild(btn);
      } catch(e) { console.error('createAdminButton failed', e); }
    })();

    // Reveal helper: call `revealAdminButton()` from the console or your admin UI
    // to show the hidden button. This keeps it out of the regular UI.
    function revealAdminButton(){ try { const b = document.getElementById('adminDeleteAllBtn'); if (b) b.style.display='block'; } catch(e){} }


    // Open inline editor overlay for a given design item
    // Open inline editor to replace a gallery image
    function openDesignEditor(itemDiv, type, idx, originalSrc) {
      // prevent multiple editors
      if (itemDiv.querySelector('.design-editor')) return;

      const storageKey = `gallery_override_${type}_${idx}`;

      const editor = document.createElement('div');
      editor.className = 'design-editor';

      const urlInput = document.createElement('input');
      urlInput.type = 'text';
      urlInput.placeholder = 'Image URL (paste)';
      urlInput.value = localStorage.getItem(storageKey) || '';

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';

      const actions = document.createElement('div');
      actions.className = 'editor-actions';

      const saveBtn = document.createElement('button');
      saveBtn.type = 'button';
      saveBtn.textContent = 'Save';
      saveBtn.onclick = () => {
        const urlVal = urlInput.value && urlInput.value.trim();
        if (urlVal) {
          localStorage.setItem(storageKey, urlVal);
          itemDiv.style.backgroundImage = `url('${urlVal}')`;
          editor.remove();
          return;
        }
        alert('Please provide an image URL or upload a file.');
      };

      const uploadBtn = document.createElement('button');
      uploadBtn.type = 'button';
      uploadBtn.textContent = 'Upload';
      uploadBtn.onclick = () => fileInput.click();

      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.textContent = 'Clear';
      clearBtn.onclick = () => {
        localStorage.removeItem(storageKey);
        itemDiv.style.backgroundImage = `url('${originalSrc}')`;
        editor.remove();
      };

      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.textContent = 'Close';
      closeBtn.onclick = () => editor.remove();

      // file handling
      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(loadEv) {
          const dataUrl = loadEv.target.result;
          // save as data URL in localStorage (be mindful of size)
          try {
            localStorage.setItem(storageKey, dataUrl);
            itemDiv.style.backgroundImage = `url('${dataUrl}')`;
            editor.remove();
          } catch (err) {
            alert('Failed to save image locally (storage quota). Try using an image URL instead.');
            console.error(err);
          }
        };
        reader.readAsDataURL(f);
      });

      actions.appendChild(saveBtn);
      actions.appendChild(uploadBtn);
      actions.appendChild(clearBtn);
      actions.appendChild(closeBtn);

      editor.appendChild(urlInput);
      editor.appendChild(fileInput);
      editor.appendChild(actions);

      itemDiv.appendChild(editor);
    }

    // Close the design gallery modal
    function closeGallery() {
      document.getElementById("designModal").style.display = "none";
    }

    window.openGallery = openGallery;
    window.closeGallery = closeGallery;

    // Online modal handlers
    // Open the e-Burol online modal (live streaming info)
    function openOnlineModal() {
      const m = document.getElementById('onlineModal');
      if (m) m.style.display = 'flex';
    }

    // Close the e-Burol online modal
    function closeOnlineModal() {
      const m = document.getElementById('onlineModal');
      if (m) m.style.display = 'none';
    }

    window.openOnlineModal = openOnlineModal;
    window.closeOnlineModal = closeOnlineModal;

    // Certificates modal handlers
    // Open Certificates & Permits modal to view images
    function openCertificatesModal() {
      const m = document.getElementById('certificatesModal');
      if (m) m.style.display = 'flex';
      // attach click handlers to certificate images inside the modal
      setTimeout(() => {
        const grid = document.getElementById('certificatesGrid');
        if (!grid) return;
        const imgs = grid.querySelectorAll('img');
        imgs.forEach(img => {
          if (img.dataset._lightboxBound) return;
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', (e) => {
            e.stopPropagation();
            openLightbox(img.src, img.alt || 'Certificate');
          });
          img.dataset._lightboxBound = '1';
        });
      }, 50);
    }

    // Close the Certificates & Permits modal
    function closeCertificatesModal() {
      const m = document.getElementById('certificatesModal');
      if (m) m.style.display = 'none';
    }

    // Show image in full-screen lightbox when a certificate is clicked
    function openLightbox(src, alt) {
      const lb = document.getElementById('imgLightbox');
      const img = document.getElementById('lbImage');
      if (!lb || !img) return;
      img.src = src;
      img.alt = alt || 'Certificate';
      lb.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close the lightbox (overlay) when clicked outside or on close
    function closeLightbox(e) {
      // allow clicking overlay or close button only
      if (e && e.target && e.target.id === 'lbImage') return; // clicking image shouldn't close
      const lb = document.getElementById('imgLightbox');
      const img = document.getElementById('lbImage');
      if (!lb) return;
      lb.style.display = 'none';
      if (img) img.src = '';
      document.body.style.overflow = '';
    }

    window.openCertificatesModal = openCertificatesModal;
    window.closeCertificatesModal = closeCertificatesModal;

    // Ensure mobile full-screen mode is cleared when resizing to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth > 600) {
        const box = document.getElementById('floatingChatBox');
        if (box) {
          box.classList.remove('mobile');
          document.body.style.overflow = '';
          // ensure nav is reset when resizing to desktop
          document.body.classList.remove('chat-active');
        }
      }
    });

    /* Obituary pagination functions */
    // Manage pagination for Obituaries (page numbers)
    function updateObituaryPagination(perPage = 6) {
      const grid = document.getElementById('obituaryGrid');
      const paginationContainer = document.getElementById('obituaryPagination');
      if (!grid || !paginationContainer) return;

      const cards = Array.from(document.querySelectorAll('.obituary-card'));
      const visibleCards = cards.filter(c => !c.classList.contains('hidden'));
      const total = visibleCards.length;
      const totalPages = Math.max(1, Math.ceil(total / perPage));

      let currentPage = parseInt(paginationContainer.getAttribute('data-page') || '1', 10);
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      // Hide all cards first
      cards.forEach(c => c.style.display = 'none');

      // Show cards for current page
      const start = (currentPage - 1) * perPage;
      const pageItems = visibleCards.slice(start, start + perPage);
      pageItems.forEach(c => c.style.display = '');

      // Build pagination controls
      paginationContainer.innerHTML = '';

      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'â€¹ Prev';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        paginationContainer.setAttribute('data-page', String(currentPage - 1));
        updateObituaryPagination(perPage);
      });
      paginationContainer.appendChild(prevBtn);

      // show small range of pages if many
      const maxPagesToShow = 7;
      let startPage = 1;
      let endPage = totalPages;
      if (totalPages > maxPagesToShow) {
        startPage = Math.max(1, currentPage - 3);
        endPage = startPage + maxPagesToShow - 1;
        if (endPage > totalPages) {
          endPage = totalPages;
          startPage = endPage - maxPagesToShow + 1;
        }
      }

      for (let p = startPage; p <= endPage; p++) {
        const btn = document.createElement('button');
        btn.textContent = String(p);
        if (p === currentPage) btn.classList.add('active');
        btn.addEventListener('click', () => {
          paginationContainer.setAttribute('data-page', String(p));
          updateObituaryPagination(perPage);
        });
        paginationContainer.appendChild(btn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next â€º';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        paginationContainer.setAttribute('data-page', String(currentPage + 1));
        updateObituaryPagination(perPage);
      });
      paginationContainer.appendChild(nextBtn);
    }

    // initialize pagination when the script runs and after small delay
    setTimeout(() => {
      updateObituaryPagination(6);
    }, 50);
  </script>

  <script>
  (function(){
    const navToggle = document.getElementById('navToggle');
    const navContainer = document.querySelector('.nav-container');

    if (!navToggle || !navContainer) return;

    // Helper to set the aria-expanded attribute on the nav toggle
    function setAria(expanded) {
      navToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    }

    navToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      const isOpen = navContainer.classList.toggle('nav-open');
      setAria(isOpen);
    });

    // close when clicking outside the nav
    document.addEventListener('click', function(e) {
      if (!navContainer.contains(e.target) && navContainer.classList.contains('nav-open')) {
        navContainer.classList.remove('nav-open');
        setAria(false);
      }
    });

    // close on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && navContainer.classList.contains('nav-open')) {
        navContainer.classList.remove('nav-open');
        setAria(false);
        navToggle.focus();
      }
      if (e.key === 'Escape') {
        const modal = document.getElementById("designModal");
        if (modal && modal.style.display === "flex") {
          modal.style.display = "none";
        }
      }
    });

    // close after clicking a nav link
    document.querySelectorAll('.main-nav a').forEach(a => {
      a.addEventListener('click', function() {
        if (navContainer.classList.contains('nav-open')) {
          navContainer.classList.remove('nav-open');
          setAria(false);
        }
      });
    });
  })();
  </script>

  <!-- the iframe script left unchanged -->
  <script>
  (function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a438647f5f81099',t:'MTc2NDA5ODY0OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
  </script>

<!-- Floating Chat Widget -->
  <div class="floating-chat-icon" id="floatingChatIcon" title="Chat with Lora">ðŸ’¬</div>
  <div class="floating-chat-box" id="floatingChatBox">
    <div class="floating-chat-header">
      <span>Chat with Lora</span>
      <button class="floating-chat-close" id="floatingChatClose" aria-label="Close chat">âœ•</button>
    </div>
    <div class="floating-chat-messages" id="floatingChatMessages">
      <div class="floating-chat-msg bot">
        <strong>Lora:</strong> Hi! I'm Lora. I can help answer questions about Solara Farewell. What would you like to know?
      </div>
    </div>
    <div class="floating-chat-input-area">
      <input type="text" id="floatingChatInput" class="floating-chat-input" placeholder="Ask me anything..." />
      <button id="floatingChatSend" class="floating-chat-send">Send</button>
    </div>
  </div>

  <!-- Floating Chat Logic / Lora Chat Bot Functionality -->
  <script>
  (function(){
    'use strict';

    // Kumuha ng lahat ng chat elements mula sa HTML / Get all chat elements
    const icon = document.getElementById('floatingChatIcon');
    const box = document.getElementById('floatingChatBox');
    const closeBtn = document.getElementById('floatingChatClose');
    const inputEl = document.getElementById('floatingChatInput');
    const sendBtn = document.getElementById('floatingChatSend');
    const messagesEl = document.getElementById('floatingChatMessages');

    if (!icon || !box || !closeBtn || !inputEl || !sendBtn || !messagesEl) return;

    // Simulan ang chat history mula sa initial message / Initialize chat history
    try {
      const initialBot = messagesEl.querySelector('.floating-chat-msg.bot');
      if (initialBot) {
        let botText = initialBot.textContent || initialBot.innerText || '';
        botText = botText.replace(/^Lora[:]?\s*/i, '').trim();
        if (botText) CHAT_HISTORY.push({ role: 'bot', text: botText });
      }
    } catch (e) { /* ignore */ }

    // I-toggle ang chat box kapag i-click ang icon / Toggle chat when icon is clicked
    icon.addEventListener('click', () => {
      const isOpen = box.classList.toggle('active');
      icon.classList.toggle('active', isOpen);

      // Sa mobile screens, gawing modal ang chat para sa better UX / Make chat modal on mobile
      if (window.innerWidth <= 600) {
        if (isOpen) {
          box.classList.add('mobile');
          // Pigilan ang page scroll habang bukas ang chat / Prevent page scroll
          document.body.style.overflow = 'hidden';
        } else {
          box.classList.remove('mobile');
          document.body.style.overflow = '';
        }
      }

      // Panatilihing visible ang navigation sa mobile / Keep nav visible on mobile
      document.body.classList.toggle('chat-active', isOpen && window.innerWidth <= 600);

      if (isOpen) {
        // I-focus ang input pagkatapos ng layout change / Focus input after layout settles
        setTimeout(() => inputEl.focus(), 200);
      }
    });

    // I-close ang chat kapag i-click ang close button / Close chat on close button click
    closeBtn.addEventListener('click', () => {
      icon.classList.remove('active');
      box.classList.remove('active');
      // Alisin ang mobile styling at i-restore ang page scroll / Remove mobile styling
      box.classList.remove('mobile');
      document.body.style.overflow = '';
      // I-reset ang chat-active class / Reset navigation position
      document.body.classList.remove('chat-active');
    });

    // Friendly greetings for various questions (English and Tagalog)
    // Mga pang-araw-araw na salita na ginagamit bilang pagsasalubong / Greeting patterns
    const GREETINGS = {
      'hello|hi|hey|greetings|kumusta|halo|habang': 'Hey there! ðŸ‘‹ I\'m Lora, your friendly assistant here at Solara Farewell. How can I help you today?',
      'how are you|how\'re you|how you doing|kumusta ka|paano ka': 'I\'m doing great, thank you for asking! ðŸ˜Š I\'m here to help you with any questions about Solara Farewell and our services.',
      'thanks|thank you|appreciate it|salamat|maraming salamat|thank you very much': 'You\'re very welcome! ðŸ’™ I\'m here to help anytime you need.',
      'goodbye|bye|see you|paalam|hanggang sa muli|babay': 'Take care! ðŸ‘‹ Feel free to reach out anytime if you have more questions. We\'re here for you.',
      'what is your name|who are you|what\'s your name|sino ka|ano ang pangalan mo|ano ang iyong pangalan': 'I\'m Lora, your friendly assistant here at Solara Farewell. I\'m here to answer all your questions about our services and help guide you through this journey. ðŸ’™'
    };

    const STOPWORDS = new Set([
      'the','a','an','is','are','of','to','in','on','for','with','and','or','about','this','that','our','your','we','you','do','does','what','when','how','can','be','it','us','i','me','my','would','should','could','just',
      // Tagalog stopwords / Mga English at Tagalog na walang kahulugan (para sa text processing)
      'ang','ang','na','ng','sa','ay','si','at','o','pero','kung','dahil','kaya','ito','iyon','kami','tayo','kayo','sila','ako','ikaw','niya','iyong','kaniya','natin','ninyo','silang'
    ]);

    // Mga keyword synonyms para sa mas mahusay na pag-unawa / Synonyms dictionary para ma-match ang iba't ibang salita
    const SYN = {
      price: ['cost','fee','fees','how much','pricing','prices','expense','afford','expensive','presyo','halaga','bayad','magkano','bili'],
      phone: ['contact','number','call','telephone','mobile','reach','dial','tawagan','numero','telepono','ipon','makipag-ugnayan'],
      address: ['location','where','located','address','place','office','building','lokasyon','saan','direksyon','lugar','opisina','gusali'],
      hours: ['time','open','opening','24/7','availability','when','schedule','oras','bukas','araw at gabi','ilan','itinerary'],
      cremation: ['cremate','cremations','ashes','cremated','ash','kremation','apoy','usok','abaw'],
      burial: ['burials','casket','caskets','coffin','grave','cemetery','libing','kapon','talunan','sementeryo','libing lugar'],
      obituary: ['obituaries','obits','search','memorial','papasok','alay','alaala','handog','patahay'],
      flowers: ['blooms','gift','gifts','flower','floral','bouquet','bulaklak','regalo','bulaklak koponan','handog'],
      help: ['assist','support','aid','help','guidance','advice','tulong','suporta','gabay','payo','aawa'],
      service: ['service','package','plan','option','offering','provide','serbisyo','pakete','plano','alok','ibigay']
    };

    // I-convert ang text sa lowercase at alisin ang special characters / Convert text to lowercase for processing
    // Normalize text (lowercase, remove punctuation) for matching
    function normalize(str){
      return (str || '').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
    }

    // Imano ng chat history para sa context ng conversation / Store chat messages for context
    const CHAT_HISTORY = [];
    const HISTORY_LIMIT = 12; // Bilang ng nakaraang mensahe na isasaalang-alang / Number of past messages to remember

    // I-split ang text sa mga keywords at maghanap ng synonyms / Split text into keywords and find related words
    // Tokenize text and expand synonyms to extract intent words
    function tokenize(str){
      const base = normalize(str).split(' ').filter(Boolean).filter(t => !STOPWORDS.has(t));
      const expanded = new Set(base);
      base.forEach(t => {
        Object.keys(SYN).forEach(k => {
          if (t === k || SYN[k].includes(t)) {
            expanded.add(k);
            SYN[k].forEach(w => expanded.add(w.replace(/\s+/g,' ')));
          }
        });
      });
      return Array.from(expanded);
    }

    // Gumawa ng knowledge base item (tanong at sagot) / Create a knowledge base entry with question and answer
    // Create a KB item from question and answer (used for matching)
    function makeKBItem(q, a, source){
      const text = `${q} ${a}`.trim();
      return {
        q, a, source,
        norm: normalize(text),
        tokens: new Set(tokenize(text))
      };
    }

    // Itayo ang knowledge base - database ng mga tanong at sagot / Build knowledge base with Q&A pairs
    const KB = [];

    // 1) FAQs
    document.querySelectorAll('.faq-item').forEach(item => {
      const qEl = item.querySelector('.faq-chip');
      const aEl = item.querySelector('.faq-answer');
      if (!qEl || !aEl) return;
      const q = qEl.textContent.trim();
      const a = aEl.textContent.trim();
      KB.push(makeKBItem(q, a, 'FAQs'));
    });

    // 2) Services
    document.querySelectorAll('#services .service-card').forEach(card => {
      const t = card.querySelector('h3') ? card.querySelector('h3').textContent.trim() : '';
      const p = card.querySelector('p') ? card.querySelector('p').textContent.trim() : '';
      if (t || p) KB.push(makeKBItem(t || 'Service', p, 'Services'));
    });

    // 3) Online memorial
    KB.push(makeKBItem(
      'Online memorial e-Burol virtual ceremony',
      'Solara e-Burol allows remote participation via live streaming for memorial services. Perfect if you cannot attend in person.',
      'Services'
    ));

    // 4) Contact details
    const phone = (document.getElementById('contact-phone') || document.getElementById('phone'))?.textContent?.trim() || '0999 604 0668';
    const email = (document.getElementById('contact-email'))?.textContent?.trim() || '';
    const address = (document.getElementById('address'))?.textContent?.trim() || 'Gen T. De Leon, Valenzuela City';
    KB.push(makeKBItem('Contact phone reach us call', `${phone}`, 'Contact'));
    KB.push(makeKBItem('Contact email address', `${email}`, 'Contact'));
    KB.push(makeKBItem('Where are you located address location', `ðŸ“ **Solara Farewell Location:**\n\nAddress: Gen T. De Leon, Valenzuela City\nPhone: ${phone}\nHours: Open 24/7\n\nWe're conveniently located in Valenzuela City. Visit us anytime, or call us at ${phone} for directions or to discuss your needs. Our compassionate team is always ready to assist you.`, 'Contact'));
    KB.push(makeKBItem('Business hours open', 'We are open 24/7 to serve you with care and compassion, whenever you need us.', 'Contact'));

    // 5) Support
    const supports = Array.from(document.querySelectorAll('#support .support-buttons a')).map(a => a.textContent.trim()).filter(Boolean);
    if (supports.length){
      KB.push(makeKBItem('Grief Support resources help', `We offer support resources including: ${supports.join(', ')}. These resources can help you through this journey.`, 'Support'));
    }

    // 6) Obituaries
    KB.push(makeKBItem(
      'Obituaries search find memorial',
      'You can search for obituaries on our page. Use the search box to filter by name, and navigate through results using page numbers. It\'s easy to find and remember loved ones.',
      'Obituaries'
    ));

    // 7) Flowers gifts
    document.querySelectorAll('#flowers .flower-card').forEach(card => {
      const name = card.querySelector('.flower-name')?.textContent?.trim() || '';
      const price = card.querySelector('.flower-price')?.textContent?.trim() || '';
      if (name || price) {
        KB.push(makeKBItem(`${name} flower arrangement gift`, `We offer beautiful ${name} arrangements at ${price}. Perfect for honoring your loved one.`, 'Flowers'));
      }
    });

    // Add comprehensive general knowledge base
    const generalKB = [
      makeKBItem('What is Solara Farewell', 'Solara Farewell is a compassionate memorial service provider dedicated to honoring your loved ones with dignity, respect, and care. We\'ve been serving families for decades.', 'About'),
      makeKBItem('Do you provide funeral services', 'Yes! We provide a complete range of services including burial, cremation, memorial ceremonies, online services, flowers, and more. We\'re here to support you every step of the way.', 'Services'),
      makeKBItem('What services do you offer', 'We offer: âœ¨ Burial Services (Basic, Premium, Deluxe) âœ¨ Cremation Services (Basic, Memorial, Premium) âœ¨ Online Memorial Services âœ¨ Flowers & Gifts âœ¨ Support Resources âœ¨ Obituaries', 'Services'),
      makeKBItem('How much does it cost price', 'We offer services at various price points to fit different budgets. From basic to premium options, we have something for everyone. Please contact us for specific pricing details.', 'Pricing'),
      makeKBItem('Can I attend remotely online', 'Yes! Our Solara e-Burol service allows you to participate in memorial services via live streaming, no matter where you are.', 'Services'),
      makeKBItem('Do you help with arrangements planning', 'Absolutely! Our compassionate staff is here to guide you through every step. We help with planning ceremonies, selecting caskets or urns, arranging flowers, and more.', 'Services'),
      makeKBItem('Is cremation better than burial', 'Both cremation and burial are valid options. Each has different costs and traditions. We\'re happy to explain the differences and help you choose what\'s best for your family.', 'Services'),
      makeKBItem('Can I rent a casket', 'Yes, many families choose rental caskets for viewings or ceremonies and then use a simpler container for cremation to help manage costs. We can help arrange this.', 'Services'),
      makeKBItem('What if I need help with grief', 'We offer grief and support resources to help you through this difficult time. Our support team can guide you to counseling, support groups, and other resources.', 'Support'),
      makeKBItem('Can I search for obituaries', 'Yes! Visit our Obituaries section to search for and view memorial information about loved ones. You can also submit obituaries for publication.', 'Obituaries'),
      makeKBItem('How do I submit an obituary', 'Contact us directly at 0999 604 0668 and our team will help you submit and publish an obituary for your loved one.', 'Obituaries'),
      makeKBItem('What flowers do you recommend', 'We offer beautiful floral arrangements perfect for memorials. White lilies, roses, and chrysanthemums are traditional choices. Browse our flower selections or ask us for recommendations!', 'Flowers'),
      makeKBItem('Do you offer same day service', 'We understand emergencies happen. Please call us immediately at 0999 604 0668 and we\'ll do our best to assist you with immediate needs.', 'Services'),
      makeKBItem('How far in advance should I plan', 'You can plan services immediately or in advance. We\'re here 24/7 to help whether it\'s an emergency or pre-planned arrangement.', 'Services'),
      makeKBItem('What is a memorial ceremony', 'A memorial ceremony is a meaningful gathering to celebrate and honor the life of your loved one. It can include religious or secular elements, music, eulogies, and flowers.', 'Services'),
      makeKBItem('Can families customize services', 'Yes! Every person is unique, and we believe their farewell should be too. We work with families to create personalized services that truly reflect their loved one\'s spirit.', 'Services'),
      
      // Ordering information
      makeKBItem('How do I order place order', 'Ordering is easy! You can: 1) Call us at 0999 604 0668 to speak with our team directly 2) Visit our office at Gen T. De Leon, Valenzuela City 3) Click the "Inquire Now" button on our website. Our compassionate staff will guide you through the process.', 'Ordering'),
      makeKBItem('How to order services step by step', 'Step 1: Click "Inquire Now" on our website or call 0999 604 0668. Step 2: Choose your service type (Burial or Cremation). Step 3: Select your package (Basic, Premium, or Deluxe). Step 4: Select additional options like caskets, urns, or flowers. Step 5: Confirm details with our team. We\'ll handle the rest!', 'Ordering'),
      makeKBItem('Can I order flowers online', 'Yes! You can browse our beautiful flower arrangements on the website and let us know your selection. Call us at 0999 604 0668 to place your order, or visit in person. We offer same-day arrangements for many occasions.', 'Flowers & Ordering'),
      makeKBItem('Can I order a casket urn', 'Absolutely! You can choose from our casket and urn designs. Browse our gallery on the website to see options, or call 0999 604 0668 to discuss your preferences. Our team will help you select the perfect option.', 'Ordering'),
      makeKBItem('What happens after I order', 'After ordering: 1) Our team will confirm all details with you 2) We\'ll arrange pickup if needed 3) We\'ll schedule your service 4) We\'ll provide setup and guidance 5) We\'ll be there for you throughout. You can call us at 0999 604 0668 anytime with questions.', 'Ordering'),
      makeKBItem('Do you offer payment plans installments', 'Yes! We understand that costs matter. We offer flexible payment options to fit your budget. Please contact us at 0999 604 0668 to discuss payment arrangements that work for you.', 'Pricing & Ordering'),
      makeKBItem('Can I modify my order', 'Of course! If you need to make changes to your order, simply call us at 0999 604 0668. Our team is happy to adjust your selections, add options, or make any modifications you need.', 'Ordering'),
      makeKBItem('What is the quickest way to order', 'The quickest way is to call us directly at 0999 604 0668. Our team can take your order over the phone immediately and start planning your service. We\'re available 24/7!', 'Ordering'),
      makeKBItem('Where can I order', 'You can order by: ðŸ“ž Phone: 0999 604 0668 ðŸ¢ Visit us: Gen T. De Leon, Valenzuela City ðŸ’» Online: Use the "Inquire Now" button on our website All methods are equally easy and our team is ready to help!', 'Ordering'),
      makeKBItem('What do I need to have ready when ordering', 'Have ready: 1) Information about your loved one 2) Preferred service type (burial or cremation) 3) Budget range if you have one 4) Any special requests or preferences 5) A phone number where we can reach you. Our team will guide you through the rest!', 'Ordering'),
      
      // Tagalog translations/entries
      makeKBItem('Ano ang Solara Farewell tungkol sa amin', 'Ang Solara Farewell ay isang compassionate na serbisyo sa paglalayag na nakatuon sa pagpaparangal sa inyong mga mahal sa buhay nang may dignidad, paggalang, at pag-aalaga. Kami ay naglingkod sa mga pamilya sa loob ng maraming dekada.', 'About'),
      makeKBItem('Nagbibigay ba kayo ng serbisyong pangburol libing', 'Oo! Nagbibigay kami ng kumpleto at iba\u2019t ibang serbisyo kabilang ang libing, kremation, seremonyang alaala, online na serbisyo, bulaklak, at marami pang iba. Nandito kami para suportahan kayo sa bawat hakbang.', 'Services'),
      makeKBItem('Ano ang mga serbisyong inaalok ninyo presyo', 'Nag-aalok kami ng: âœ¨ Libing (Basic, Premium, Deluxe) âœ¨ Kremation (Basic, Memorial, Premium) âœ¨ Online Memorial âœ¨ Bulaklak & Mga Regalo âœ¨ Support Resources âœ¨ Obituaries', 'Services'),
      makeKBItem('Magkano ang halaga presyo bayad kostumer', 'Nag-aalok kami ng iba\u2019t ibang presyo upang matugunan ang inyong badyet. Mula sa basic hanggang premium na mga opsyon, mayroon kaming para sa lahat. Makipag-ugnayan sa amin para sa detalyadong presyo.', 'Pricing'),
      makeKBItem('Saan kayo naroroon lokasyon direksyon address', 'ðŸ“ **Lokasyon ng Solara Farewell:**\n\nAnyaya: Gen T. De Leon, Valenzuela City\nTelefono: 0999 604 0668\nOras: Bukas 24/7\n\nKami ay nasa Valenzuela City. Bumisita sa amin anumang oras, o tawagan kami sa 0999 604 0668 para sa direksyon o upang tuklasin ang inyong pangangailangan. Ang aming mapagmahal na koponan ay handang tumulong.', 'Contact'),
      makeKBItem('Paano ako makakaugnayan sa inyo tawagan', 'Maaari kayong makipag-ugnayan sa amin sa pamamagitan ng telepono: 0999 604 0668. Kami ay bukas 24/7 upang tulungan kayo.', 'Contact'),
      makeKBItem('Puwede ba akong dumalo online manood live', 'Oo! Ang aming Solara e-Burol ay nagbibigay-daan sa inyo na lumahok sa memorial services sa pamamagitan ng live streaming, saanman kayo naroroon.', 'Services'),
      makeKBItem('Tumutulong ba kayo sa pag-aayos ng serbisyo plano', 'Oo! Ang aming mapagmahal na koponan ay nandito upang gabayan kayo sa bawat hakbang. Tinutulungan namin kayo sa pagpaplano ng seremonyas, pagpili ng kapon o urn, pag-aayos ng bulaklak, at marami pang iba.', 'Services'),
      makeKBItem('Paano ako makakapag-order ng bulaklak regalo flowers', 'Oo! Maaari ninyong tingnan ang aming magagandang bulaklak na kaayaan sa website at ipaalam sa amin ang inyong pinili. Tawagan kami sa 0999 604 0668 upang mag-order, o bumisita sa amin nang personal. Nag-aalok kami ng parehong araw na paghahatid sa maraming lugar.', 'Flowers & Ordering'),
      makeKBItem('Paano ako makakapag-order paano ang proseso order', 'Madali! Maaari kayong: 1) Tawagan kami sa 0999 604 0668 2) Bumisita sa amin sa Gen T. De Leon, Valenzuela City 3) I-click ang \"Inquire Now\" sa aming website. Ang aming koponan ay gagabay sa inyo sa proseso.', 'Ordering'),
      makeKBItem('Bukas ba kayo 24/7 oras ilan na bukas', 'Kami ay bukas 24/7 upang maglingkod sa inyo nang may pag-ibig at malasakit, kahit anong oras kayo kailangan namin.', 'Contact')
    ];

    KB.push(...generalKB);

    // Check if the query is a simple greeting (hi, kumusta)
    function checkGreeting(query) {
      const normalized = normalize(query);
      for (let [pattern, response] of Object.entries(GREETINGS)) {
        const patterns = pattern.split('|');
        if (patterns.some(p => normalized.includes(p))) {
          return response;
        }
      }
      return null;
    }

    // Score the query against the KB to find the best match
    function scoreQuery(query){
      const qNorm = normalize(query);
      const qTokens = new Set(tokenize(query));
      let best = {item: null, score: -1};

      KB.forEach(it => {
        let overlap = 0;
        qTokens.forEach(t => { if (it.tokens.has(t)) overlap++; });
        const includesBonus = it.norm.includes(qNorm) ? 2 : 0;
        const s = overlap + includesBonus;
        if (s > best.score) best = {item: it, score: s};
      });
      return best;
    }

    // Magdagdag ng mensahe sa chat window (user o bot message) / Add message to chat display
    function appendMsg(role, text, source){
      const div = document.createElement('div');
      div.className = `floating-chat-msg ${role}`;
      
      if (role === 'user') {
        div.textContent = text;
      } else {
        const strong = document.createElement('strong');
        strong.textContent = 'Lora: ';
        div.appendChild(strong);
        const span = document.createElement('span');
        span.textContent = text;
        div.appendChild(span);
        
        if (source) {
          const sourceEl = document.createElement('div');
          sourceEl.className = 'source';
          sourceEl.textContent = `Source: ${source}`;
          div.appendChild(sourceEl);
        }
      }
      
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // I-save ang mensahe sa history para sa context (limitahan lang ang nakaraang entries) / Store in chat history
      if (role === 'user' || role === 'bot') {
        CHAT_HISTORY.push({ role, text: typeof text === 'string' ? text : String(text) });
        if (CHAT_HISTORY.length > HISTORY_LIMIT) CHAT_HISTORY.splice(0, CHAT_HISTORY.length - HISTORY_LIMIT);
      }
    }

    // Pangasiwaan ang tanong ng user - maghanap sa KB o mag-call ng AI / Handle user question with KB lookup or AI
    async function handleUserQuestion(text){
      const q = (text || '').trim();
      if (!q) return;

      // Append user message to UI and history
      appendMsg('user', q);

      // Special admin reveal: if the user types exactly "admin" (case-insensitive), reveal the hidden admin button
      try {
        if (q.toLowerCase() === 'admin') {
          try { revealAdminButton(); } catch(e){}
          document.getElementById('typing-indicator')?.remove();
          appendMsg('bot', 'Admin mode enabled. The admin control has been revealed.', 'System');
          return;
        }
      } catch(e) { /* ignore */ }

      // Show typing indicator
      const typingDiv = document.createElement('div');
      typingDiv.className = 'floating-chat-msg bot';
      typingDiv.innerHTML = '<strong>Lora:</strong> <span style="opacity: 0.7;">typing...</span>';
      typingDiv.id = 'typing-indicator';
      messagesEl.appendChild(typingDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try {
        // Check for jumbled/gibberish text first
        if (isJumbledText(q)) {
          document.getElementById('typing-indicator')?.remove();
          appendMsg('bot', 'I apologize, but I\'m having trouble understanding that message. ðŸ˜Š Could you please rephrase your question? If you\'re having difficulty communicating, I\'d recommend reaching out to our team directly at 0999 604 0668. They\'re available 24/7 to help you!', 'Lora');
          return;
        }

        // Check for greeting first (instant response)
        const greetingResponse = checkGreeting(q);
        if (greetingResponse) {
          document.getElementById('typing-indicator')?.remove();
          appendMsg('bot', greetingResponse, 'Lora');
          return;
        }

        // Try to get answer from knowledge base first
        const {item, score} = scoreQuery(q);
        if (item && score > 0) {
          document.getElementById('typing-indicator')?.remove();
          appendMsg('bot', item.a, item.source || 'This page');
          return;
        }

        // Use real AI for unknown questions
        // Build a stronger system prompt and include recent conversation history for context
        const systemPrompt = `You are Lora, a compassionate, helpful, and highly knowledgeable assistant for Solara Farewell (a memorial services provider). Answer clearly, empathetically, and concisely. If the user asks for local contact details, provide the phone number 0999 604 0668 and encourage calling for urgent help. When appropriate, ask a clarifying question instead of guessing. Always be respectful.`;

        // Serialize recent chat history into the prompt
        const recent = CHAT_HISTORY.slice(-HISTORY_LIMIT);
        let convo = '';
        recent.forEach(m => {
          if (m.role === 'user') convo += `User: ${m.text}\n`;
          else convo += `Assistant: ${m.text}\n`;
        });

        // For offline/local mode, pass the user's raw question to the local responder
        const aiResponse = await getAIResponse(q);
        document.getElementById('typing-indicator')?.remove();
        
        if (aiResponse) {
          // For real questions, add context about Solara Farewell
          const contextualResponse = `${aiResponse}\n\nIf you need specific information about Solara Farewell's services, please feel free to call us at 0999 604 0668 or explore our website for more details.`;
          appendMsg('bot', contextualResponse, 'AI Assistant');
        } else {
          throw new Error('No response from AI');
        }
      } catch (error) {
        document.getElementById('typing-indicator')?.remove();
        console.error('Error:', error);
        const fallbackResponse = 'I apologize, but I\'m having trouble connecting to the AI service at the moment. ðŸ˜Š However, I\'d love to help! Please call us at 0999 604 0668 and our compassionate team will assist you right away.';
        appendMsg('bot', fallbackResponse, 'Lora');
      }
    }

    // Function to call real AI APIs with multiple fallbacks
    // Taglish: Get AI response (local enhanced generator first; API fallbacks if enabled)
    async function getAIResponse(userMessage) {
      // Offline-only mode: use enhanced local response generator
      try {
        const local = generateLocalResponse(userMessage);
        if (local) return local;
        // If no direct match, ask enhanced generator to compose a helpful reply
        return generateEnhancedLocalResponse(userMessage);
      } catch (err) {
        console.error('Local response generation error:', err);
        return null;
      }
    }

    // Call local Gemini proxy server
    // Taglish: (Optional) Call Gemini proxy server to get remote AI reply
    async function tryGeminiAPI(userMessage) {
      try {
        const res = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });
        if (!res.ok) {
          console.warn('Gemini proxy returned non-OK', res.status);
          return null;
        }
        const data = await res.json();
        if (data && data.text) return data.text.substring(0, 1000);
        return null;
      } catch (err) {
        console.error('Error calling Gemini proxy:', err);
        return null;
      }
    }

    // Try HuggingFace API (most reliable free option)
    // Taglish: (Optional) Try HuggingFace model inference endpoint
    async function tryHuggingFaceAPI(userMessage) {
      try {
        const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            inputs: `You are Lora, a helpful and compassionate AI assistant. Answer the following question clearly and helpfully:\n\n${userMessage}\n\nLora:`,
            parameters: {
              max_new_tokens: 512,
              temperature: 0.6,
              top_k: 50
            }
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data[0] && data[0].generated_text) {
            const fullText = data[0].generated_text;
            const answer = fullText.split('Lora:')[1] || fullText;
            return answer.trim().substring(0, 1000);
          }
        }
        return null;
      } catch (error) {
        console.error('HuggingFace API error:', error);
        return null;
      }
    }

    // Try Groq API
    // Taglish: (Optional) Try Groq/OpenRouter style API for remote reply
    async function tryGroqAPI(userMessage) {
      try {
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'HTTP-Referer': window.location.href,
            'X-Title': 'Solara Farewell Chat'
          },
          body: JSON.stringify({
            model: 'mistral-7b-instruct:free',
            messages: [
              {
                  role: 'system',
                  content: 'You are Lora, a friendly and helpful AI assistant for Solara Farewell. Answer any question clearly and compassionately. When helpful, ask a clarifying question instead of guessing.'
              },
              {
                role: 'user',
                    content: userMessage
              }
            ],
                temperature: 0.6,
                max_tokens: 600
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.choices && data.choices[0] && data.choices[0].message) {
            return data.choices[0].message.content;
          }
        }
        return null;
      } catch (error) {
        console.error('Groq API error:', error);
        return null;
      }
    }

    // Smart local response generator as final fallback
    // Taglish: Simple pattern-based local responder (fast fallback)
    function generateLocalResponse(userMessage) {
      const msg = userMessage.toLowerCase();
      
      // Check if the message is gibberish/jumbled text
      if (isJumbledText(userMessage)) {
        return 'I apologize, but I\'m having trouble understanding that message. ðŸ˜Š Could you please rephrase your question? If you\'re having difficulty communicating, I\'d recommend reaching out to our team directly at 0999 604 0668. They\'re available 24/7 to help you!';
      }
      
      // General knowledge responses
      const responses = {
        'how are you|what\'s up|how\'s it going': 'I\'m doing well, thank you for asking! ðŸ˜Š How can I help you today?',
        'what is ai|what are you': 'I\'m Lora, an AI assistant powered by advanced language models. I\'m here to answer your questions about Solara Farewell and anything else you\'d like to know!',
        'tell me about|explain|what is': generateExplanation(userMessage),
        'how do i|how can i': generateHowTo(userMessage),
        'why': generateWhy(userMessage),
        'what': generateWhat(userMessage)
      };

      for (let [pattern, response] of Object.entries(responses)) {
        const patterns = pattern.split('|');
        if (patterns.some(p => msg.includes(p))) {
          return response || 'That\'s an interesting question! I\'d be happy to help. Could you provide more details?';
        }
      }

      // This is a real question but doesn't match patterns - will be answered by AI
      return null;
    }

    // Enhanced local compositional responder - builds answers from KB and templates
    // Taglish: Compositional responder that uses KB + templates for better answers
    function generateEnhancedLocalResponse(userMessage) {
      const q = normalize(userMessage);
      // 1) Try KB scoring
      const best = scoreQuery(userMessage);
      if (best && best.item && best.score > 0) {
        // return KB answer with source
        return `${best.item.a}\n\n(Reference: ${best.item.source})`;
      }

      // 2) Look for intent tokens
      const toks = tokenize(userMessage);
      if (toks.includes('price') || toks.includes('cost') || toks.includes('pricing')) {
        return 'Our service pricing varies by package. For accurate pricing please call 0999 604 0668 or click Inquire Now â€” we can give you an exact quote and explain payment options.';
      }
      if (toks.includes('phone') || toks.includes('contact') || toks.includes('call')) {
        return `You can reach us by phone at 0999 604 0668. We're available 24/7 to assist you.`;
      }
      if (toks.includes('order') || toks.includes('how to order') || toks.includes('place order')) {
        return 'To place an inquiry or order: 1) Click the Inquire Now button on the site 2) Call us at 0999 604 0668 3) Visit us at Gen T. De Leon, Valenzuela City. Which of these would you prefer?';
      }
      if (toks.includes('flowers') || toks.includes('flower')) {
        return 'We offer a selection of floral arrangements. White lilies, roses, and chrysanthemums are common choices. Would you like recommendations for a sympathy arrangement or a standing spray?';
      }

      // 3) If question looks like a clarification (contains question words), offer help and examples
      if (q.startsWith('how') || q.startsWith('what') || q.startsWith('why') || q.startsWith('where') || q.startsWith('when') || q.startsWith('who')) {
        return "That's a great question â€” I don't have the exact answer in our local data, but I can help walk you through it. Could you tell me a bit more about what you need (e.g., pricing, timing, location, or package type)? Or I can provide general guidance right away.";
      }

      // 4) Default fallback: constructive guidance + call-to-action
      return "I can help with that. Could you share a little more detail? For urgent matters, please call us at 0999 604 0668. If you'd like, ask me something specific like 'How much is a basic burial' or 'What does the premium package include'.";
    }

    // Tukuyin kung ang text ay random/gibberish o tunay na mensahe / Detect if text is random/gibberish
    function isJumbledText(text) {
      // Sinusuri ang patterns ng characters para malaman kung meaningless / Check character patterns
      if (!text || text.length < 3) return false;
      
      // Bilangan ang vowels at mga patterns / Count vowels for analysis
      const vowels = (text.match(/[aeiouAEIOU]/g) || []).length;
      const vowelRatio = vowels / text.length;
      
      // Bilangan ang repeated characters na walang saysay / Count repeated characters
      let repeatCount = 0;
      for (let i = 0; i < text.length - 1; i++) {
        if (text[i] === text[i + 1]) repeatCount++;
      }
      const repeatRatio = repeatCount / text.length;
      
      // Tingnan ang average word length at spacing / Analyze word length
      const spaces = (text.match(/\s/g) || []).length;
      const words = text.trim().split(/\s+/).length;
      const avgWordLength = text.replace(/\s/g, '').length / words;
      
      // Hanapin ang patterns ng gibberish: maunting vowels, maraming repeated chars / Detect gibberish patterns
      // - Very few vowels (less than 15% of text)
      // - Too many repeated characters (more than 20%)
      // - Very short words with many numbers/special chars
      // - Single very long word with random characters
      
      if (vowelRatio < 0.15) return true; // Halos walang vowels / Almost no vowels
      if (repeatRatio > 0.25) return true; // Too many repeated chars
      if (avgWordLength > 15 && words === 1) return true; // One very long gibberish word
      
      // Check if mostly numbers and special characters (no real words)
      const alphaCount = (text.match(/[a-zA-Z]/g) || []).length;
      const nonAlphaCount = text.replace(/\s/g, '').length - alphaCount;
      if (alphaCount > 0 && nonAlphaCount / alphaCount > 1.5) return true; // More symbols than letters
      
      return false;
    }

    // Taglish: Helper - gumawa ng maikling paliwanag depende sa keyword (explainers)
    function generateExplanation(msg) {
      if (msg.includes('funeral')) return 'A funeral is a ceremony to honor and remember someone who has passed away. It often includes a gathering, eulogies, and a tribute to the deceased\'s life. Solara Farewell specializes in creating meaningful and respectful funeral services.';
      if (msg.includes('cremation')) return 'Cremation is a process where a deceased body is reduced to ashes through intense heat. It\'s an alternative to traditional burial. Many families choose cremation for various personal, cultural, or economic reasons.';
      if (msg.includes('memorial')) return 'A memorial service is a gathering to celebrate and honor the life of someone who has passed away. Unlike a funeral, the body may not be present. It\'s a time for family and friends to share memories and support each other.';
      return 'I can explain that in more detail. What specifically would you like to know?';
    }

    // Taglish: Helper - gumawa ng step-by-step na sagot kapag how-to ang tanong
    function generateHowTo(msg) {
      if (msg.includes('order')) return 'You can order services from Solara Farewell by: 1) Calling us at 0999 604 0668, 2) Visiting our location at Gen T. De Leon, Valenzuela City, or 3) Clicking the "Inquire Now" button on our website. Our team is available 24/7 to assist you.';
      if (msg.includes('arrange')) return 'To arrange a funeral or memorial service, contact Solara Farewell at 0999 604 0668. Our compassionate staff will guide you through selecting services, packages, flowers, and all other details. We\'re here to help every step of the way.';
      if (msg.includes('plan')) return 'Planning a service involves discussing your preferences with our team, selecting a service type (burial or cremation), choosing a package (basic, premium, or deluxe), and selecting additional options like flowers or urns. We handle all the logistics!';
      return 'Great question! I can help walk you through that process. What would you like to know more about?';
    }

    // Taglish: Helper - sagutin ang why-style na tanong nang maikli
    function generateWhy(msg) {
      if (msg.includes('cremation')) return 'People choose cremation for various reasons: it\'s often more affordable than burial, takes up less space, can align with personal or cultural beliefs, and allows for flexible memorial options. Solara Farewell offers multiple cremation packages to fit different needs.';
      if (msg.includes('funeral')) return 'Funerals and memorials are important because they allow families and loved ones to gather, share memories, grieve together, and honor the life of the deceased. They provide closure and community support during a difficult time.';
      return 'That\'s a thoughtful question. I\'d like to help you understand more. What specifically are you wondering about?';
    }

    // Taglish: Helper - sagutin what-style questions o magbigay ng pagkakaiba
    function generateWhat(msg) {
      if (msg.includes('difference|difference between')) return 'The main differences between services are: Burial involves placing the body in the ground, Cremation reduces the body to ashes, and Memorial services are gatherings to celebrate the deceased. Each has different costs, practices, and cultural significance.';
      if (msg.includes('included')) return 'Our service packages typically include ceremony arrangements, casket or urn selection, flowers, obituary assistance, and support throughout the process. The specific inclusions depend on which package you choose.';
      return 'That\'s an important question! I\'m here to help clarify. Could you tell me more about what you\'d like to know?';
    }

    // I-connect ang input at send button sa chat handler / Wire input to message handler
    sendBtn.addEventListener('click', () => {
      const text = inputEl.value;
      inputEl.value = '';
      handleUserQuestion(text);
    });

    // Tumanggap din ng Enter key para magpadala ng mensahe / Also send on Enter key press
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        const text = inputEl.value;
        inputEl.value = '';
        handleUserQuestion(text);
      }
    });

    // I-expose ang function para makuha ng iba / Make function accessible globally
    window.floatingChatAsk = handleUserQuestion;
  })();
  </script>

  <!-- Site Popup Ad (shows on every visit) -->
  <style>
    /* Popup Ad styles (smaller modal) */
    #siteAdModal {
      display: none; /* shown via JS on each load */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 110000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #siteAdModal.show { display: flex; }
    .site-ad-content {
      position: relative;
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      max-width: 420px; /* reduced size */
      width: calc(100% - 48px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.28);
      text-align: center;
      overflow: hidden;
    }
    .site-ad-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.98);
      border: 1px solid rgba(0,0,0,0.08);
      font-size: 16px;
      cursor: pointer;
      color: #000;
      padding: 6px 8px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.10);
      line-height: 1;
    }
    .site-ad-close[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .site-ad-img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      display: block;
      margin: 0 auto 6px auto;
      width: 100%;
    }
    .site-ad-text {
      margin-top: 6px;
      color: #222;
      font-size: 0.92rem;
    }

    @media (max-width: 480px) {
      .site-ad-content { padding: 10px; border-radius: 8px; max-width: 360px; }
      .site-ad-close { font-size: 15px; top:6px; right:6px; }
      #siteAdTimer { left:12px; top:10px; font-size:0.9rem; }
    }
  </style>

  <div id="siteAdModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="site-ad-content" role="document">
      <div id="siteAdTimer" style="position:absolute; left:16px; top:12px; font-size:0.95rem; color:#000; font-weight:600;">Closing in <span id="siteAdTimerSec">5</span>s</div>
      <button id="siteAdClose" class="site-ad-close" aria-label="Close ad">âœ•</button>
      <a id="siteAdLink" href="#services" rel="noopener noreferrer">
        <img id="siteAdImage" class="site-ad-img" src="ad.jpg" alt="Sponsored" />
      </a>
      <div class="site-ad-text">Sponsored â€” <strong>Click to learn more</strong></div>
    </div>
  </div>

  <script>
    (function(){
      // Config: change these values to use a specific image / URL / alt text
      const AD_IMAGE_SRC = 'ad.png'; // replace with your ad image filename or URL
      const AD_TARGET_URL = '#services'; // link to services section on this page
      const AD_ALT = 'Sponsored';
      const AD_COUNTDOWN_SECONDS = 5; // seconds until close button becomes visible

      const modal = document.getElementById('siteAdModal');
      const closeBtn = document.getElementById('siteAdClose');
      const img = document.getElementById('siteAdImage');
      const link = document.getElementById('siteAdLink');
      const timerEl = document.getElementById('siteAdTimer');
      const timerSec = document.getElementById('siteAdTimerSec');

      // state
      let countdown = Math.max(0, parseInt(AD_COUNTDOWN_SECONDS, 10) || 0);
      let countdownFinished = false;
      let countdownInterval = null;

      // Apply config
      if (img) img.src = AD_IMAGE_SRC;
      if (img) img.alt = AD_ALT;
      if (link) link.href = AD_TARGET_URL;
      // Show the close button but keep it disabled until countdown finishes
      if (closeBtn) {
        closeBtn.disabled = true;
        closeBtn.setAttribute('aria-disabled', 'true');
      }

      function startCountdown() {
        if (!timerEl || countdown <= 0) return showClose();
        timerSec.textContent = String(countdown);
        countdownInterval = setInterval(() => {
          countdown -= 1;
          timerSec.textContent = String(Math.max(0, countdown));
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            showClose();
          }
        }, 1000);
      }

      function showClose() {
        countdownFinished = true;
        if (closeBtn) {
          closeBtn.disabled = false;
          closeBtn.removeAttribute('aria-disabled');
        }
        if (timerEl) timerEl.style.display = 'none';
      }

      function showAd() {
        if (!modal) return;
        modal.classList.add('show');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        // set initial focus to the ad link for easy navigation
        try { link && link.focus(); } catch (e) { /* ignore */ }
        // kick off countdown
        startCountdown();
      }

      function hideAd() {
        if (!modal) return;
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      // Show on every page load
      document.addEventListener('DOMContentLoaded', function(){
        setTimeout(showAd, 350);
        // cleanup any expired pendings and check for current pending booking
        try { cleanPendingBookings(); } catch(e){}
        try { renderPendingBanner(); } catch(e){}
        // floating Pending button removed; inbox panel remains available via banner actions
      });

      // Close interactions - only after countdown finished
      if (closeBtn) closeBtn.addEventListener('click', function(){ if (countdownFinished) hideAd(); });
      // clicking outside should only close after countdown
      modal && modal.addEventListener('click', function(e){
        if (e.target === modal && countdownFinished) hideAd();
      });
      // close on ESC only after countdown
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && modal && modal.classList.contains('show') && countdownFinished) {
          hideAd();
        }
      });

      // If the user clicks the ad link, allow navigation immediately (per request)
      if (link) link.addEventListener('click', function(){
        // when linking to an anchor on the same page, close the modal so user sees the section
        // allow default behavior then hide the modal
        setTimeout(hideAd, 50);
      });
    })();

    // --- Initialize Firestore for shared bookings across users ---
    document.addEventListener('DOMContentLoaded', function(){
      const firebaseConfig = {
        apiKey: "AIzaSyCkucRBhTgRK63-A5YeMZhKHwTo_Upt_1c",
        authDomain: "solara-1c4d7.firebaseapp.com",
        projectId: "solara-1c4d7",
        storageBucket: "solara-1c4d7.firebasestorage.app",
        messagingSenderId: "91832847660",
        appId: "1:91832847660:web:b242364d3f9a8ab97a7089"
      };
      try {
        setupFirestore(firebaseConfig);
        console.log('Firestore initialized successfully. Shared bookings enabled.');
      } catch (e) {
        console.warn('Firestore setup skipped or failed:', e.message);
      }
    });
  </script>




